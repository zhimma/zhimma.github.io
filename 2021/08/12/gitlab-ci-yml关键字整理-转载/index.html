<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.zhimma.com","root":"/","scheme":"Muse","version":"8.0.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}};
  </script>

  <meta name="description" content="[toc] Gitlab CI&#x2F;CD 管道配置参考在每个项目中，使用名为.gitlab-ci.yml 的 yaml 文件配置 Gitlab CI&#x2F;CD 管道。 .gitlab-ci.yml 文件定义了管道的结构和顺序，并确定： 使用 Gitlab Runner 执行什么。 遇到特殊情况时要做什么决定？例如，当一个进程成功或失败时。 本主题介绍 CI&#x2F;CD 管道配置。有关其他 CI&#x2F;CD 配置信息，">
<meta property="og:type" content="article">
<meta property="og:title" content="gitlab-ci.yml关键字整理(转载)">
<meta property="og:url" content="https://blog.zhimma.com/2021/08/12/gitlab-ci-yml%E5%85%B3%E9%94%AE%E5%AD%97%E6%95%B4%E7%90%86-%E8%BD%AC%E8%BD%BD/index.html">
<meta property="og:site_name" content="zhimma&#39;s blog">
<meta property="og:description" content="[toc] Gitlab CI&#x2F;CD 管道配置参考在每个项目中，使用名为.gitlab-ci.yml 的 yaml 文件配置 Gitlab CI&#x2F;CD 管道。 .gitlab-ci.yml 文件定义了管道的结构和顺序，并确定： 使用 Gitlab Runner 执行什么。 遇到特殊情况时要做什么决定？例如，当一个进程成功或失败时。 本主题介绍 CI&#x2F;CD 管道配置。有关其他 CI&#x2F;CD 配置信息，">
<meta property="og:locale">
<meta property="article:published_time" content="2021-08-12T10:07:59.000Z">
<meta property="article:modified_time" content="2021-08-12T10:09:36.033Z">
<meta property="article:author" content="zhimma">
<meta property="article:tag" content="Gitlab">
<meta property="article:tag" content="DevOps">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://blog.zhimma.com/2021/08/12/gitlab-ci-yml%E5%85%B3%E9%94%AE%E5%AD%97%E6%95%B4%E7%90%86-%E8%BD%AC%E8%BD%BD/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>gitlab-ci.yml关键字整理(转载) | zhimma's blog</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="zhimma's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">zhimma's blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Gitlab-CI-CD-%E7%AE%A1%E9%81%93%E9%85%8D%E7%BD%AE%E5%8F%82%E8%80%83"><span class="nav-number">1.</span> <span class="nav-text">Gitlab CI&#x2F;CD 管道配置参考</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.1.</span> <span class="nav-text">1. 介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E9%AA%8C%E8%AF%81-gitlab-ci-yml"><span class="nav-number">1.2.</span> <span class="nav-text">2. 验证 .gitlab-ci.yml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Unavailable-names-for-jobs"><span class="nav-number">1.3.</span> <span class="nav-text">3. Unavailable names for jobs</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E4%BD%BF%E7%94%A8%E4%BF%9D%E7%95%99%E5%85%B3%E9%94%AE%E5%AD%97"><span class="nav-number">1.4.</span> <span class="nav-text">4. 使用保留关键字</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0"><span class="nav-number">1.5.</span> <span class="nav-text">5. 配置参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E8%AE%BE%E7%BD%AE%E9%BB%98%E8%AE%A4%E5%8F%82%E6%95%B0"><span class="nav-number">1.6.</span> <span class="nav-text">6. 设置默认参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E5%8F%82%E6%95%B0%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF"><span class="nav-number">1.7.</span> <span class="nav-text">7. 参数详细信息</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-script"><span class="nav-number">1.7.1.</span> <span class="nav-text">7.1. script</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-image"><span class="nav-number">1.8.</span> <span class="nav-text">7.2. image</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#image-name"><span class="nav-number">1.8.1.</span> <span class="nav-text">image:name</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#image-entrypoint"><span class="nav-number">1.8.2.</span> <span class="nav-text">image:entrypoint</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-services"><span class="nav-number">1.9.</span> <span class="nav-text">7.3. services</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#services-name"><span class="nav-number">1.9.1.</span> <span class="nav-text">services:name</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#services-alias"><span class="nav-number">1.9.2.</span> <span class="nav-text">services:alias</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#services-entrypoint"><span class="nav-number">1.9.3.</span> <span class="nav-text">services:entrypoint</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#services-command"><span class="nav-number">1.9.4.</span> <span class="nav-text">services:command</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-before-script-after-script"><span class="nav-number">1.10.</span> <span class="nav-text">7.4. before_script &#x2F; after_script</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-stages"><span class="nav-number">1.11.</span> <span class="nav-text">7.5. stages</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-6-stage"><span class="nav-number">1.12.</span> <span class="nav-text">7.6. stage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-7-only-except-basic"><span class="nav-number">1.13.</span> <span class="nav-text">7.7. only&#x2F;except (basic)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Regular-expressions"><span class="nav-number">1.13.1.</span> <span class="nav-text">Regular expressions</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-8-only-except-advanced-%E9%AB%98%E7%BA%A7"><span class="nav-number">1.14.</span> <span class="nav-text">7.8. only&#x2F;except (advanced) 高级</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#only-refs-except-refs"><span class="nav-number">1.14.1.</span> <span class="nav-text">only:refs&#x2F;except:refs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#only-kubernetes-except-kubernetes"><span class="nav-number">1.14.2.</span> <span class="nav-text">only:kubernetes&#x2F;except:kubernetes</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#only-variables-except-variables"><span class="nav-number">1.14.3.</span> <span class="nav-text">only:variables&#x2F;except:variables</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#only-changes-except-changes"><span class="nav-number">1.14.4.</span> <span class="nav-text">only:changes&#x2F;except:changes</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-9-tags"><span class="nav-number">1.15.</span> <span class="nav-text">7.9. tags</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-10-allow-failure"><span class="nav-number">1.16.</span> <span class="nav-text">7.10. allow_failure</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-11-when"><span class="nav-number">1.17.</span> <span class="nav-text">7.11. when</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#when-manual"><span class="nav-number">1.17.1.</span> <span class="nav-text">when:manual</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#when-delayed"><span class="nav-number">1.17.2.</span> <span class="nav-text">when:delayed</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-12-environment"><span class="nav-number">1.18.</span> <span class="nav-text">7.12. environment</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#environment-name"><span class="nav-number">1.18.1.</span> <span class="nav-text">environment:name</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#environment-url"><span class="nav-number">1.18.2.</span> <span class="nav-text">environment:url</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#environment-on-stop"><span class="nav-number">1.18.3.</span> <span class="nav-text">environment:on_stop</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#environment-action"><span class="nav-number">1.18.4.</span> <span class="nav-text">environment:action</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-13-cache"><span class="nav-number">1.19.</span> <span class="nav-text">7.13. cache</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#cache-paths"><span class="nav-number">1.19.1.</span> <span class="nav-text">cache:paths</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cache-key"><span class="nav-number">1.19.2.</span> <span class="nav-text">cache:key</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cache-untracked"><span class="nav-number">1.19.3.</span> <span class="nav-text">cache:untracked</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cache-policy"><span class="nav-number">1.19.4.</span> <span class="nav-text">cache:policy</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-14-artifacts"><span class="nav-number">1.20.</span> <span class="nav-text">7.14. artifacts</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#artifacts-paths"><span class="nav-number">1.20.1.</span> <span class="nav-text">artifacts:paths</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#artifacts-name"><span class="nav-number">1.20.2.</span> <span class="nav-text">artifacts:name</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#artifacts-untracked"><span class="nav-number">1.20.3.</span> <span class="nav-text">artifacts:untracked</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#artifacts-when"><span class="nav-number">1.20.4.</span> <span class="nav-text">artifacts:when</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#artifacts-expire-in"><span class="nav-number">1.20.5.</span> <span class="nav-text">artifacts:expire_in</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#artifacts-reports"><span class="nav-number">1.20.6.</span> <span class="nav-text">artifacts:reports</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#artifacts-reports-junit"><span class="nav-number">1.20.7.</span> <span class="nav-text">artifacts:reports:junit</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#artifacts-reports-codequality-STARTER"><span class="nav-number">1.20.8.</span> <span class="nav-text">artifacts:reports:codequality (STARTER)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#artifacts-reports-sast-ULTIMATE-%E7%BB%88%E6%9E%81"><span class="nav-number">1.20.9.</span> <span class="nav-text">artifacts:reports:sast (ULTIMATE) 终极</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#artifacts-reports-dependency-scanning-ULTIMATE-%E7%BB%88%E6%9E%81"><span class="nav-number">1.20.10.</span> <span class="nav-text">artifacts:reports:dependency_scanning (ULTIMATE) 终极</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#artifacts-reports-container-scanning-ULTIMATE"><span class="nav-number">1.20.11.</span> <span class="nav-text">artifacts:reports:container_scanning (ULTIMATE)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#artifacts-reports-dast-ULTIMATE"><span class="nav-number">1.20.12.</span> <span class="nav-text">artifacts:reports:dast (ULTIMATE)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#artifacts-reports-license-management-ULTIMATE"><span class="nav-number">1.20.13.</span> <span class="nav-text">artifacts:reports:license_management (ULTIMATE)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#artifacts-reports-performance-PREMIUM"><span class="nav-number">1.20.14.</span> <span class="nav-text">artifacts:reports:performance (PREMIUM)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#artifacts-reports-metrics-PREMIUM"><span class="nav-number">1.20.15.</span> <span class="nav-text">artifacts:reports:metrics (PREMIUM)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#artifacts-reports-metrics-PREMIUM-1"><span class="nav-number">1.20.16.</span> <span class="nav-text">artifacts:reports:metrics (PREMIUM)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-15-dependencies"><span class="nav-number">1.21.</span> <span class="nav-text">7.15. dependencies</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#When-a-dependent-job-will-fail"><span class="nav-number">1.21.1.</span> <span class="nav-text">When a dependent job will fail</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-16-coverage"><span class="nav-number">1.22.</span> <span class="nav-text">7.16. coverage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-17-retry"><span class="nav-number">1.23.</span> <span class="nav-text">7.17. retry</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-18-parallel"><span class="nav-number">1.24.</span> <span class="nav-text">7.18. parallel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-19-trigger-PREMIUM"><span class="nav-number">1.25.</span> <span class="nav-text">7.19. trigger (PREMIUM)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-20-include"><span class="nav-number">1.26.</span> <span class="nav-text">7.20. include</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#include-local"><span class="nav-number">1.26.1.</span> <span class="nav-text">include:local</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#include-file"><span class="nav-number">1.26.2.</span> <span class="nav-text">include:file</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#include-template"><span class="nav-number">1.26.3.</span> <span class="nav-text">include:template</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#include-remote"><span class="nav-number">1.26.4.</span> <span class="nav-text">include:remote</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B5%8C%E5%A5%97%E5%8C%85%E5%90%AB"><span class="nav-number">1.26.5.</span> <span class="nav-text">嵌套包含</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%87%8D%E6%96%B0%E4%BD%BF%E7%94%A8%E5%89%8D%E8%84%9A%E6%9C%AC%E6%A8%A1%E6%9D%BF"><span class="nav-number">1.26.6.</span> <span class="nav-text">重新使用前脚本模板</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%B5%8C%E5%A5%97%E7%9A%84-include"><span class="nav-number">1.26.7.</span> <span class="nav-text">使用嵌套的 include</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-21-extends"><span class="nav-number">1.27.</span> <span class="nav-text">7.21. extends</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Using-extends-and-include-together"><span class="nav-number">1.27.1.</span> <span class="nav-text">Using extends and include together</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-22-pages"><span class="nav-number">1.28.</span> <span class="nav-text">7.22. pages</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-23-variables"><span class="nav-number">1.29.</span> <span class="nav-text">7.23. variables</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Git-strategy"><span class="nav-number">1.29.1.</span> <span class="nav-text">Git strategy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Git-submodule-strategy"><span class="nav-number">1.29.2.</span> <span class="nav-text">Git submodule strategy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Git-checkout"><span class="nav-number">1.29.3.</span> <span class="nav-text">Git checkout</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Git-clean-flags"><span class="nav-number">1.29.4.</span> <span class="nav-text">Git clean flags</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Job-stages-attempts"><span class="nav-number">1.29.5.</span> <span class="nav-text">Job stages attempts</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Shallow-cloning"><span class="nav-number">1.29.6.</span> <span class="nav-text">Shallow cloning</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E4%B8%8D%E6%8E%A8%E8%8D%90%E4%BD%BF%E7%94%A8%E7%9A%84%E5%8F%82%E6%95%B0-%E8%A7%81%E5%8E%9F%E6%96%87"><span class="nav-number">1.30.</span> <span class="nav-text">8. 不推荐使用的参数 (见原文)</span></a></li></ol></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">zhimma</p>
  <div class="site-description" itemprop="description">zhimma's 技术blog</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">72</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">36</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://blog.zhimma.com/2021/08/12/gitlab-ci-yml%E5%85%B3%E9%94%AE%E5%AD%97%E6%95%B4%E7%90%86-%E8%BD%AC%E8%BD%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhimma">
      <meta itemprop="description" content="zhimma's 技术blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhimma's blog">
    </span>

    
    
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          gitlab-ci.yml关键字整理(转载)
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-08-12 18:07:59 / Modified: 18:09:36" itemprop="dateCreated datePublished" datetime="2021-08-12T18:07:59+08:00">2021-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Gitlab/" itemprop="url" rel="index"><span itemprop="name">Gitlab</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Gitlab/DevOps/" itemprop="url" rel="index"><span itemprop="name">DevOps</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>[toc]</p>
<h2 id="Gitlab-CI-CD-管道配置参考"><a href="#Gitlab-CI-CD-管道配置参考" class="headerlink" title="Gitlab CI/CD 管道配置参考"></a>Gitlab CI/CD 管道配置参考</h2><p>在每个项目中，使用名为.gitlab-ci.yml 的 yaml 文件配置 Gitlab CI/CD 管道。</p>
<p>.gitlab-ci.yml 文件定义了管道的结构和顺序，并确定：</p>
<p>使用 Gitlab Runner 执行什么。</p>
<p>遇到特殊情况时要做什么决定？例如，当一个进程成功或失败时。</p>
<p>本主题介绍 CI/CD 管道配置。有关其他 CI/CD 配置信息，请参阅：</p>
<p>Gitlab CI/CD 变量，用于配置管道运行的环境。</p>
<p>Gitlab Runner 高级配置，用于配置 Gitlab Runner。</p>
<p>我们有配置管道的完整示例：</p>
<p>要快速介绍 Gitlab CI，请遵循我们的快速入门指南。</p>
<p>有关示例的集合，请参见 Gitlab CI/CD 示例。</p>
<p>要查看企业中使用的大型.gitlab-ci.yml 文件，请参见 gitlab ce 的.gitlab-ci.yml 文件。</p>
<blockquote>
<p>如果你有一个镜像存储库，其中有 gitlab，你可能需要在项目的 Settings &gt; Repository &gt; Pull from a remote repository &gt; Trigger 镜像更新管道。</p>
</blockquote>
<h3 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1. 介绍"></a>1. 介绍</h3><p>管道配置从 job 开始。jobs 是.gitlab-ci.yml 文件最基本的元素。</p>
<p>工作包括：</p>
<p>定义了在什么条件下应该执行它们的约束。</p>
<p>具有任意名称的顶级元素，必须至少包含 script 子句。</p>
<p>不限于可定义的数量。</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">job1:</span><br><span class="line">  script: &quot;execute-script-for-job1&quot;</span><br><span class="line">job2:</span><br><span class="line">  script: &quot;execute-script-for-job2&quot;</span><br></pre></td></tr></table></figure>

<p>上面的示例是最简单的 CI/CD 配置，有两个独立的 job，其中每个 job 执行不同的命令。当然，命令可以直接执行代码（./configure；make；make install）或者在存储库中运行 script（test.sh）。<br>工作由 Runners 挑选并在 Runner 的环境。重要的是，每个 job 都在运行彼此独立。</p>
<h3 id="2-验证-gitlab-ci-yml"><a href="#2-验证-gitlab-ci-yml" class="headerlink" title="2. 验证 .gitlab-ci.yml"></a>2. 验证 .gitlab-ci.yml</h3><p>Gitlab CI 的每个实例都有一个名为 lint 的嵌入式调试工具，用于验证.gitlab-ci.yml 文件的内容。您可以在您的页面 ci/lint 下找到 lint。项目命名空间。例如，<a target="_blank" rel="noopener" href="https://gitlab.example.com/gitlab-org/project-123//ci/lint%E3%80%82">https://gitlab.example.com/gitlab-org/project-123//ci/lint。</a></p>
<h3 id="3-Unavailable-names-for-jobs"><a href="#3-Unavailable-names-for-jobs" class="headerlink" title="3. Unavailable names for jobs"></a>3. Unavailable names for jobs</h3><p>每个 job 必须有一个唯一的名称，但有一些保留的关键字不能用作 job 名称：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">image</span><br><span class="line">services</span><br><span class="line">stages</span><br><span class="line">types</span><br><span class="line">before_script</span><br><span class="line">after_script</span><br><span class="line">variables</span><br><span class="line">cache</span><br></pre></td></tr></table></figure>

<h3 id="4-使用保留关键字"><a href="#4-使用保留关键字" class="headerlink" title="4. 使用保留关键字"></a>4. 使用保留关键字</h3><p>如果在使用特定值（例如，true or false）时出现验证错误，请尝试：</p>
<p>–引用它们。</p>
<p>–将它们更改为其他形式。例如，/bin/true。</p>
<h3 id="5-配置参数"><a href="#5-配置参数" class="headerlink" title="5. 配置参数"></a>5. 配置参数</h3><p>job 定义为定义 job 行为的参数列表。</p>
<p>下表列出了 job 的可用参数：</p>
<table>
<thead>
<tr>
<th>Keyword</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>script</td>
<td>由运行程序执行的 shell 脚本。</td>
</tr>
<tr>
<td>image</td>
<td>使用 Docker 图像。还提供：image:name 和 image:entrypoint。</td>
</tr>
<tr>
<td>services</td>
<td>使用 Docker 服务图像。还提供：services:name、services:alias、services:entrypoint 和 services:command。</td>
</tr>
<tr>
<td>before_script</td>
<td>重写在 job 之前执行的一组命令。</td>
</tr>
<tr>
<td>after_script</td>
<td>重写在 job 后执行的一组命令。</td>
</tr>
<tr>
<td>stages</td>
<td>定义管道中的阶段。</td>
</tr>
<tr>
<td>stage</td>
<td>定义 job 阶段（default: test）。</td>
</tr>
<tr>
<td>only</td>
<td>限制创建 when jobs。还可用：only：refs，only：kubernetes，only：variables，only：changes。</td>
</tr>
<tr>
<td>except</td>
<td>限制未创建 when jobs。还可用：except:refs，except:kubernetes，except:variables 和 except:changes。</td>
</tr>
<tr>
<td>tags</td>
<td>用于选择运行程序的标记列表。</td>
</tr>
<tr>
<td>allow_failure</td>
<td>允许 job 失败。失败的 job 不影响提交状态。</td>
</tr>
<tr>
<td>when</td>
<td>何时运行 job。还可用：when:manual and when:delayed。</td>
</tr>
<tr>
<td>environment</td>
<td>job 部署到的环境的名称。还可用：environment:name, environment:url, environment:on_stop, and environment:action.</td>
</tr>
<tr>
<td>cache</td>
<td>在后续运行之间应缓存的文件列表。还可用：cache:paths, cache:key, cache:untracked, and cache:policy.。</td>
</tr>
<tr>
<td>artifacts</td>
<td>成功时要附加到 job 的文件和目录列表。还可用：artifacts:paths, artifacts:name, artifacts:untracked, artifacts:when, artifacts:expire_in, artifacts:reports, and artifacts:reports:junit。在 Gitlab 企业版中，这些可用：artifacts:reports:codequality, artifacts:reports:sast, artifacts:reports:dependency_scanning, artifacts:reports:container_scanning, artifacts:reports:dast, artifacts:reports:license_management, artifacts:reports:performance and artifacts:reports:metrics。</td>
</tr>
<tr>
<td>dependencies</td>
<td>job 所依赖的其他 job，以便在它们之间传递 artifacts。</td>
</tr>
<tr>
<td>coverage</td>
<td>给定 job 的代码覆盖率设置。</td>
</tr>
<tr>
<td>retry</td>
<td>如果出现故障，一个 job 可以自动重试的时间和次数。</td>
</tr>
<tr>
<td>parallel</td>
<td>一个 job 应并行运行多少个实例。</td>
</tr>
<tr>
<td>trigger</td>
<td>定义下游管道触发器。</td>
</tr>
<tr>
<td>include</td>
<td>允许此 job 包含外部 yaml 文件。还提供：include:local、include:file、include:template 和 include:remote。</td>
</tr>
<tr>
<td>extends</td>
<td>此 job 将从中继承的配置项。</td>
</tr>
<tr>
<td>pages</td>
<td>上载 job 的结果以用于 Gitlab 页面。</td>
</tr>
<tr>
<td>variables</td>
<td>在 job 级别定义 job 变量。</td>
</tr>
</tbody></table>
<blockquote>
<p>NOTE: Note:Parameters types and type are deprecated.(弃用)</p>
</blockquote>
<h3 id="6-设置默认参数"><a href="#6-设置默认参数" class="headerlink" title="6. 设置默认参数"></a>6. 设置默认参数</h3><p>某些参数可以全局设置为所有 job 的默认值，使用默认值：关键字。然后，默认参数可以被特定于 job 的参数覆盖配置。</p>
<p>可以在默认块内定义以下 job 参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">image</span><br><span class="line">services</span><br><span class="line">before_script</span><br><span class="line">after_script</span><br><span class="line">cache</span><br></pre></td></tr></table></figure>

<p>在下面的示例中，ruby:2.5 图像被设置为所有图像的默认值。job，rspec 2.6job 除外，它使用 ruby:2.6 映像：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">default:</span><br><span class="line">  image: ruby:2.5</span><br><span class="line"></span><br><span class="line">rspec:</span><br><span class="line">  script: bundle exec rspec</span><br><span class="line"></span><br><span class="line">rspec 2.6:</span><br><span class="line">  image: ruby:2.6</span><br><span class="line">  script: bundle exec rspec</span><br></pre></td></tr></table></figure>

<h3 id="7-参数详细信息"><a href="#7-参数详细信息" class="headerlink" title="7. 参数详细信息"></a>7. 参数详细信息</h3><p>以下是用于配置 CI/CD 管道的参数的详细说明。</p>
<h4 id="7-1-script"><a href="#7-1-script" class="headerlink" title="7.1. script"></a>7.1. script</h4><p>script 是 job 所需的唯一关键字。这是一个 shellscript 由运行程序执行。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">job:</span><br><span class="line">  script: &quot;bundle exec rspec&quot;</span><br></pre></td></tr></table></figure>

<p>此参数还可以包含使用数组的多个命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">job:</span><br><span class="line">  script:</span><br><span class="line">    - uname -a</span><br><span class="line">    - bundle exec rspec</span><br></pre></td></tr></table></figure>

<blockquote>
<p>有时，script 命令需要用单引号或双引号括起来。例如，包含冒号（：）的命令需要用引号括起来，因此 yaml 解析器知道将整个事件解释为字符串而不是 “key:value” 对。使用特殊字符时要小心:<br>:, {, }, [, ], ,, &amp;, *, #, ?, |, -, &lt;, &gt;, =, !, %, @, `.</p>
</blockquote>
<h3 id="7-2-image"><a href="#7-2-image" class="headerlink" title="7.2. image"></a>7.2. image</h3><p>用于指定要用于 job 的 Docker 映像。</p>
<p>用于：</p>
<p>简单定义示例，<a target="_blank" rel="noopener" href="https://gitlab.com/help/ci/docker/using_docker_images.md#define-image-and-services-from-gitlab-ciyml">请参见从.gitlab-ci.yml 定义图像和服务。</a></p>
<p>详细使用信息，<a target="_blank" rel="noopener" href="https://gitlab.com/help/ci/docker/README.md">请参阅 Docker 集成文档。</a></p>
<h4 id="image-name"><a href="#image-name" class="headerlink" title="image:name"></a>image:name</h4><p><a target="_blank" rel="noopener" href="https://gitlab.com/help/ci/docker/using_docker_images.md#extended-docker-configuration-options">扩展 Docker 配置选项。</a></p>
<p>有关详细信息，<a target="_blank" rel="noopener" href="https://gitlab.com/help/ci/docker/using_docker_images.md#available-settings-for-image">请参阅图像的可用设置。</a></p>
<h4 id="image-entrypoint"><a href="#image-entrypoint" class="headerlink" title="image:entrypoint"></a>image:entrypoint</h4><p>扩展 Docker 配置选项。</p>
<p>有关详细信息，请参阅图像的可用设置。</p>
<h3 id="7-3-services"><a href="#7-3-services" class="headerlink" title="7.3. services"></a>7.3. services</h3><p>用于指定服务 Docker 映像，链接到映像中指定的基映像。</p>
<p>用于：</p>
<p>简单定义示例，请参见从.gitlab-ci.yml 定义图像和服务。</p>
<p>详细使用信息，请参阅 Docker 集成文档。</p>
<p>例如服务，<a target="_blank" rel="noopener" href="https://gitlab.com/help/ci/services/README.md">请参见 Gitlab CI Services。</a></p>
<h4 id="services-name"><a href="#services-name" class="headerlink" title="services:name"></a>services:name</h4><p>扩展 Docker 配置选项。有关详细信息，<a target="_blank" rel="noopener" href="https://gitlab.com/help/ci/docker/using_docker_images.md#available-settings-for-services"> 请参阅 “服务的可用设置”。</a></p>
<h4 id="services-alias"><a href="#services-alias" class="headerlink" title="services:alias"></a>services:alias</h4><p>扩展 Docker 配置选项。有关详细信息，请参阅 “服务的可用设置”。</p>
<h4 id="services-entrypoint"><a href="#services-entrypoint" class="headerlink" title="services:entrypoint"></a>services:entrypoint</h4><p>扩展 Docker 配置选项。有关详细信息，请参阅 “服务的可用设置”。</p>
<h4 id="services-command"><a href="#services-command" class="headerlink" title="services:command"></a>services:command</h4><p>扩展 Docker 配置选项。有关详细信息，请参阅 “服务的可用设置”。</p>
<h3 id="7-4-before-script-after-script"><a href="#7-4-before-script-after-script" class="headerlink" title="7.4. before_script / after_script"></a>7.4. before_script / after_script</h3><p>before_script 用于定义应在所有命令之前运行的命令 job，包括部署 job，但在恢复 artifacts 之后。这可以是一个数组或多行字符串。</p>
<p>after_script 用于定义将要运行的命令 job，包括失败的 job。这必须是一个数组或多行字符串。</p>
<p>在 before_script 指定的 script 是：</p>
<p>与主 script 中指定的 script 连接。工作级别在 script 定义之前覆盖全局级别在 script 定义之前与 script 定义连接时。</p>
<p>与主 scriptscript 一起在单个 shell 中作为一个 script 执行上下文。</p>
<p>after_script 指定的 script：</p>
<p>将当前工作目录设置回默认值。</p>
<p>在与 script 和 script 之前分开的 shell 上下文中执行 script。</p>
<p>由于上下文分隔，无法查看定义的 script 所做的更改在 “script” 或 “before_script”，请执行以下操作之一：</p>
<p>在外壳中。例如，script 中导出的命令别名和变量 script。</p>
<p>在工作树之外（取决于运行者执行者）。例如，由 before_script 或 scriptscript 安装的软件。</p>
<p>可以覆盖在 script 之前和之后定义的全局，如果按 job 设置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">default:</span><br><span class="line">  before_script:</span><br><span class="line">    - global before script</span><br><span class="line"></span><br><span class="line">job:</span><br><span class="line">  before_script:</span><br><span class="line">    - execute this instead of global before script</span><br><span class="line">  script:</span><br><span class="line">    - my command</span><br><span class="line">  after_script:</span><br><span class="line">    - execute this after my script</span><br></pre></td></tr></table></figure>

<h3 id="7-5-stages"><a href="#7-5-stages" class="headerlink" title="7.5. stages"></a>7.5. stages</h3><p>stages 用于全局定义 job 可以使用的阶段</p>
<p>stages 的规格允许有灵活的多级管道。stages 中元素的顺序定义了 job 执行的顺序：</p>
<p>同一阶段的 job 并行运行。</p>
<p>下一阶段的 job 在上一阶段的 job 之后运行成功完成。</p>
<p>让我们考虑下面的例子，它定义了 3 个阶段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">stages:</span><br><span class="line">  - build</span><br><span class="line">  - test</span><br><span class="line">  - deploy</span><br></pre></td></tr></table></figure>

<p>首先，build 的所有 job 都是并行执行的。</p>
<p>如果 build 的所有 job 都成功，则 test job 将并行执行。</p>
<p>如果 test 的所有 job 都成功，则 deploy job 将并行执行。</p>
<p>如果 Deploy 的所有 job 都成功，则提交标记为通过。</p>
<p>如果以前的任何 job 失败，提交将标记为失败，并且不</p>
<p>执行下一阶段的工作。</p>
<p>还有两个边缘案例值得一提：</p>
<p>如果在.gitlab-ci.yml 中没有定义阶段，默认情况下，build, test and deploy 用作 job 的阶段。</p>
<p>如果 job 未指定阶段，则该 job 将被分配到 test 阶段。</p>
<h3 id="7-6-stage"><a href="#7-6-stage" class="headerlink" title="7.6. stage"></a>7.6. stage</h3><p>stage 是定义单个 job，并依赖于全局的 stages。它允许将 job 分组到不同的阶段，并且相同的 job 阶段是并行执行的（取决于某些条件）。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">stages:</span><br><span class="line">  - build</span><br><span class="line">  - test</span><br><span class="line">  - deploy</span><br><span class="line"></span><br><span class="line">job 1:</span><br><span class="line">  stage: build</span><br><span class="line">  script: make build dependencies</span><br><span class="line"></span><br><span class="line">job 2:</span><br><span class="line">  stage: build</span><br><span class="line">  script: make build artifacts</span><br><span class="line"></span><br><span class="line">job 3:</span><br><span class="line">  stage: test</span><br><span class="line">  script: make test</span><br><span class="line"></span><br><span class="line">job 4:</span><br><span class="line">  stage: deploy</span><br><span class="line">  script: make deploy</span><br></pre></td></tr></table></figure>

<p>Using your own Runners</p>
<p>使用自己的运行程序时，默认情况下，Gitlab 运行程序一次只运行一个 job（请参见运行程序全局设置中的并发标志）。</p>
<p>只有在以下情况下，job 才会并行运行：</p>
<p>在不同程序上运行</p>
<p>运行程序的并发设置已更改。</p>
<h3 id="7-7-only-except-basic"><a href="#7-7-only-except-basic" class="headerlink" title="7.7. only/except (basic)"></a>7.7. only/except (basic)</h3><p>only 和 except 两个参数将 job 策略设置为限制创建的 job：</p>
<p>only 定义要为其运行 job 的分支和标记的名称。</p>
<p>except 定义排除的 job</p>
<p>有一些规则适用于 job 策略的使用：</p>
<p>only 和 except 是包容性的。如果只定义 only 和 except 在 job 规范中，引用 only 由和 except。</p>
<p>only 和 except 允许使用正则表达式（支持的 regexp 语法）。</p>
<p>only 和 except 允许指定用于筛选 job 的存储库路径分支。</p>
<p>此外，only 和 except 情况允许使用特殊关键字：</p>
<table>
<thead>
<tr>
<th>Value</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>branches</td>
<td>当管道的 Git 引用是分支时。</td>
</tr>
<tr>
<td>tags</td>
<td>当管道的 Git 引用是标记时。</td>
</tr>
<tr>
<td>api</td>
<td>当管道被第二个管道 API 触发时（而不是触发 API）。</td>
</tr>
<tr>
<td>external</td>
<td>使用 Gitlab 以外的 CI 服务时。</td>
</tr>
<tr>
<td>pipelines</td>
<td>对于多项目触发器，使用带有 CI_JOB_TOKEN 的 API 创建的。</td>
</tr>
<tr>
<td>pushes</td>
<td>管道由用户的 git push 触发。</td>
</tr>
<tr>
<td>schedules</td>
<td>用于计划的管道。</td>
</tr>
<tr>
<td>triggers</td>
<td>用于使用触发器标记创建的管道。</td>
</tr>
<tr>
<td>web</td>
<td>对于使用 Gitlab UI 中的 “运行管道” 按钮创建的管道（在项目的管道下）。</td>
</tr>
<tr>
<td>merge_requests</td>
<td>创建或更新合并请求时（有关合并请求，请参阅管道）。</td>
</tr>
<tr>
<td>chats</td>
<td>对于使用 gitlab chatops 命令创建的 job。</td>
</tr>
</tbody></table>
<p>在下面的示例中，job 将仅对以问题 - 开头的引用运行，鉴于将跳过所有分支：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">job:</span><br><span class="line">  # use regexp</span><br><span class="line">  only:</span><br><span class="line">    - &#x2F;^issue-.*$&#x2F;</span><br><span class="line">  # use special keyword</span><br><span class="line">  except:</span><br><span class="line">    - branches</span><br></pre></td></tr></table></figure>

<p>默认情况下，模式匹配区分大小写。使用 i 标志修饰符，如 /pattern/i 使模式不区分大小写：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">job:</span><br><span class="line">  # use regexp</span><br><span class="line">  only:</span><br><span class="line">    - &#x2F;^issue-.*$&#x2F;i</span><br><span class="line">  # use special keyword</span><br><span class="line">  except:</span><br><span class="line">    - branches</span><br></pre></td></tr></table></figure>

<p>在本例中，job 将仅对标记的引用运行，或者如果通过 API 触发器或管道计划显式请求生成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">job:</span><br><span class="line">  # use special keywords</span><br><span class="line">  only:</span><br><span class="line">    - tags</span><br><span class="line">    - triggers</span><br><span class="line">    - schedules</span><br></pre></td></tr></table></figure>

<p>存储库路径只能用于执行父存储库的 job，而不能用于分叉：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">job:</span><br><span class="line">  only:</span><br><span class="line">    - branches@gitlab-org&#x2F;gitlab-ce</span><br><span class="line">  except:</span><br><span class="line">    - master@gitlab-org&#x2F;gitlab-ce</span><br><span class="line">    - &#x2F;^release&#x2F;.*$&#x2F;@gitlab-org&#x2F;gitlab-ce</span><br></pre></td></tr></table></figure>

<p>上面的示例将为 gitlab-org/gitlab-ce 上的所有分支运行 job，master 和以 release / 作为前缀的分支除外。</p>
<p>only 默认值：’’branches’、’tags’]</p>
<p>except 默认值为空。</p>
<p>例如，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">job:</span><br><span class="line">  script: echo &#39;test&#39;</span><br></pre></td></tr></table></figure>

<p>转换为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">job:</span><br><span class="line">  script: echo &#39;test&#39;</span><br><span class="line">  only: [&#39;branches&#39;, &#39;tags&#39;]</span><br></pre></td></tr></table></figure>

<h4 id="Regular-expressions"><a href="#Regular-expressions" class="headerlink" title="Regular expressions"></a>Regular expressions</h4><p>因为 @用于表示引用存储库路径的开头，匹配正则表达式中包含 @字符的引用名称需要使用十六进制字符代码 match \x40。</p>
<p>只有标记或分支名称才能与正则表达式匹配。如果给定存储库路径，则始终按字面匹配。</p>
<p>如果使用正则表达式来匹配标记或分支名称，模式的整个引用名称部分必须是正则表达式，必须用 / 包围。（在结束 / 后附加正则表达式标志）因此，问题 -/.*/ 无法匹配所有标记名或分支名从问题开始。</p>
<blockquote>
<p>使用锚 ^ 和 $ 避免正则表达式只匹配标记名或分支名的子字符串。例如，/^issue-.$/ 等于 /^issue-/，而 just/issue/ 也将匹配一个称为严重问题的分支。</p>
</blockquote>
<p>Supported only/except regexp syntax</p>
<p>警告：警告：这是 Gitlab 11.9.4 引入的突破性变化。</p>
<p>在 Gitlab 11.9.4 中，Gitlab 开始内部转换使用的 regexp 仅限 RE2 和 RE2 的参数。</p>
<p>这意味着只有 RubyRegexp 提供的特性的子集支持。RE2 限制了功能集由于计算的复杂性，这意味着一些特性在 Gitlab 11.9.4 中变得不可用。例如，负数 lookaheads。</p>
<p>对于 11.9.7 到 Gitlab 12.0 的 Gitlab 版本，Gitlab 提供了一个可以由管理员启用，允许用户使用不安全的 regexp 语法。这带来了兼容性使用以前允许的语法版本，并允许用户优雅地迁移到新语法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">Feature.enable(:allow_unsafe_ruby_regexp)</span><br></pre></td></tr></table></figure>

<h3 id="7-8-only-except-advanced-高级"><a href="#7-8-only-except-advanced-高级" class="headerlink" title="7.8. only/except (advanced) 高级"></a>7.8. only/except (advanced) 高级</h3><p>警告：警告：这是一个 alpha 功能，随时可能更改，恕不另行通知！</p>
<p>Gitlab 支持简单和复杂的策略，因此可以使用数组和哈希配置方案。</p>
<p>有四把钥匙：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">refs</span><br><span class="line">variables</span><br><span class="line">changes</span><br><span class="line">kubernetes</span><br></pre></td></tr></table></figure>

<p>If you use multiple keys under only or except, they act as an AND. The logic is:</p>
<p>(any of refs) AND (any of variables) AND (any of changes) AND (if kubernetes is active)</p>
<h4 id="only-refs-except-refs"><a href="#only-refs-except-refs" class="headerlink" title="only:refs/except:refs"></a>only:refs/except:refs</h4><p>refs 策略可以采用与仅简化 / 例外配置相同的值。</p>
<p>在下面的示例中，只有在为主分支计划管道或运行管道时，才会创建部署 job：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">deploy:</span><br><span class="line">  only:</span><br><span class="line">    refs:</span><br><span class="line">      - master</span><br><span class="line">      - schedules</span><br></pre></td></tr></table></figure>

<h4 id="only-kubernetes-except-kubernetes"><a href="#only-kubernetes-except-kubernetes" class="headerlink" title="only:kubernetes/except:kubernetes"></a>only:kubernetes/except:kubernetes</h4><p>kubernetes 策略只接受活动关键字。</p>
<p>在下面的示例中，只有当项目中的 kubernetes 服务处于活动状态时，才会创建部署 job：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">deploy:</span><br><span class="line">  only:</span><br><span class="line">    kubernetes: active</span><br></pre></td></tr></table></figure>

<h4 id="only-variables-except-variables"><a href="#only-variables-except-variables" class="headerlink" title="only:variables/except:variables"></a>only:variables/except:variables</h4><p>variables 关键字用于定义变量表达式。换句话说，您可以使用预定义的变量 /project/group 或环境范围的变量来定义一个表达式 gitlab 将要评估，以决定是否应该创建一个 job。</p>
<p>使用变量表达式的示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">deploy:</span><br><span class="line">  script: cap staging deploy</span><br><span class="line">  only:</span><br><span class="line">    refs:</span><br><span class="line">      - branches</span><br><span class="line">    variables:</span><br><span class="line">      - $RELEASE &#x3D;&#x3D; &quot;staging&quot;</span><br><span class="line">      - $STAGING</span><br></pre></td></tr></table></figure>

<p>另一个用例是根据提交消息排除 job：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">end-to-end:</span><br><span class="line">  script: rake test:end-to-end</span><br><span class="line">  except:</span><br><span class="line">    variables:</span><br><span class="line">      - $CI_COMMIT_MESSAGE &#x3D;~ &#x2F;skip-end-to-end-tests&#x2F;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://gitlab.com/help/ci/variables/README.md#environment-variables-expressions">Learn more about variables expressions.</a></p>
<h4 id="only-changes-except-changes"><a href="#only-changes-except-changes" class="headerlink" title="only:changes/except:changes"></a>only:changes/except:changes</h4><p>使用 changes 关键字 only 或 except 可以定义是否应基于 Git push 事件修改的文件创建 job。</p>
<p>For example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">docker build:</span><br><span class="line">  script: docker build -t my-image:$CI_COMMIT_REF_SLUG .</span><br><span class="line">  only:</span><br><span class="line">    changes:</span><br><span class="line">      - Dockerfile</span><br><span class="line">      - docker&#x2F;scripts&#x2F;*</span><br><span class="line">      - dockerfiles&#x2F;**&#x2F;*</span><br><span class="line">      - more_scripts&#x2F;*.&#123;rb,py,sh&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的场景中，将多个提交推送到 Gitlab 时，分支，Gitlab 创建并触发 Docker 构建 job，前提是提交包含对以下任一项的更改：</p>
<p>Dockerfile 文件。</p>
<p>docker/scripts/directory 中的任何文件。</p>
<p>dockerfiles 目录中的任何文件和子目录。</p>
<p>more_scripts 目录中任何具有 rb、py、sh 扩展名的文件。</p>
<p>您还可以使用 glob 模式来匹配 repo 根目录或 repo 中的任何目录中的多个文件。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">test:</span><br><span class="line">  script: npm run test</span><br><span class="line">  only:</span><br><span class="line">    changes:</span><br><span class="line">      - &quot;*.json&quot;</span><br><span class="line">      - &quot;**&#x2F;*.sql&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在上面的示例中，表达式被双引号括起来，因为它们是全局模式。Gitlab 将无法解析带有未封装的 glob 模式的.gitlab-ci.yml 文件。</p>
</blockquote>
<p>如果在 repo 根目录下扩展名为.md 的任何文件中检测到更改，则以下示例将跳过 CIjob：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">build:</span><br><span class="line">  script: npm run build</span><br><span class="line">  except:</span><br><span class="line">    changes:</span><br><span class="line">      - &quot;*.md&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>警告：警告：在将此功能与新的分支和标记一起使用时，需要注意一些事项。请参阅下面的部分。</p>
</blockquote>
<p>使用带有新分支和标记的更改</p>
<p>在将新分支或新标记推送到 Gitlab 时，，策略的计算结果始终为 true，Gitlab 将创建 job。此功能尚未与合并请求连接，并且，由于 Gitlab 正在创建管道，用户才能创建合并请求，因此此时目标分支的位置未知。</p>
<p>对合并请求使用更改</p>
<p>对于合并请求的管道，可以根据合并请求中修改的文件定义要创建的 job。</p>
<p>For example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">docker build service one:</span><br><span class="line">  script: docker build -t my-service-one-image:$CI_COMMIT_REF_SLUG .</span><br><span class="line">  only:</span><br><span class="line">    refs:</span><br><span class="line">      - merge_requests</span><br><span class="line">    changes:</span><br><span class="line">      - Dockerfile</span><br><span class="line">      - service-one&#x2F;**&#x2F;*</span><br></pre></td></tr></table></figure>

<p>在上面的场景中，如果创建或更新合并请求以更改 service one 目录或 dockerfile 中的文件，那么 gitlab 将创建并触发 docker build service onejob。</p>
<h3 id="7-9-tags"><a href="#7-9-tags" class="headerlink" title="7.9. tags"></a>7.9. tags</h3><p>tags 用于从允许运行此项目的所有运行者列表中选择特定的运行者。</p>
<p>在注册运行程序期间，可以指定运行程序的 tags，例如 ruby、postgres、development。</p>
<p>tags 允许您使用分配了指定 tags 的运行者运行 job：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">job:</span><br><span class="line">  tags:</span><br><span class="line">    - ruby</span><br><span class="line">    - postgres</span><br></pre></td></tr></table></figure>

<p>上面的规范将确保 job 由同时定义了 ruby 和 postgres 标记的运行程序构建。</p>
<p>标签也是在不同平台上运行不同 job 的好方法，例如，给定一个带有标签 OSX 的 OSX 运行程序和带有标签的 Windows 运行程序 Windows，以下 job 在各自的平台上运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">windows job:</span><br><span class="line">  stage:</span><br><span class="line">    - build</span><br><span class="line">  tags:</span><br><span class="line">    - windows</span><br><span class="line">  script:</span><br><span class="line">    - echo Hello, %USERNAME%!</span><br><span class="line"></span><br><span class="line">osx job:</span><br><span class="line">  stage:</span><br><span class="line">    - build</span><br><span class="line">  tags:</span><br><span class="line">    - osx</span><br><span class="line">  script:</span><br><span class="line">    - echo &quot;Hello, $USER!&quot;</span><br></pre></td></tr></table></figure>

<h3 id="7-10-allow-failure"><a href="#7-10-allow-failure" class="headerlink" title="7.10. allow_failure"></a>7.10. allow_failure</h3><p>允许失败允许 job 失败而不影响 CI 套件的其余部分。默认值为假，手动 job 除外。</p>
<p>当启用并且 job 失败时，该 job 将在用户界面中显示橙色警告。但是，管道的逻辑流会将 job 视为成功 / 通过，并且不会被阻塞。</p>
<p>假设所有其他 job 都成功，则 job 的阶段及其管道将显示相同的橙色警告。但是，关联的提交将被标记为 “通过”，没有警告。</p>
<p>在下面的示例中，job1 和 job2 将并行运行，但如果 job1 失败，则不会停止下一阶段的运行，因为它标记为 allow_failure:true:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">job1:</span><br><span class="line">  stage: test</span><br><span class="line">  script:</span><br><span class="line">    - execute_script_that_will_fail</span><br><span class="line">  allow_failure: true</span><br><span class="line"></span><br><span class="line">job2:</span><br><span class="line">  stage: test</span><br><span class="line">  script:</span><br><span class="line">    - execute_script_that_will_succeed</span><br><span class="line"></span><br><span class="line">job3:</span><br><span class="line">  stage: deploy</span><br><span class="line">  script:</span><br><span class="line">    - deploy_to_staging</span><br></pre></td></tr></table></figure>

<h3 id="7-11-when"><a href="#7-11-when" class="headerlink" title="7.11. when"></a>7.11. when</h3><p>用于实现在失败或失败时运行的 job。</p>
<p>when 可以设置为以下值之一：</p>
<p>on_success - 仅当先前阶段的所有 job 成功时执行 job（或由于标记为 “允许失败” 而被视为成功）。这是默认设置。</p>
<p>on_failure - 仅当先前阶段中的至少一个 job 失败时才执行 job。</p>
<p>always - 执行 job，而不管先前阶段的 job 状态如何。</p>
<p>manual - 手动执行 job（在 Gitlab 8.10 中添加）。<a target="_blank" rel="noopener" href="https://gitlab.com/help/ci/yaml/README.md#whenmanual">阅读下面的手动操作</a> 。</p>
<p>For example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">stages:</span><br><span class="line">  - build</span><br><span class="line">  - cleanup_build</span><br><span class="line">  - test</span><br><span class="line">  - deploy</span><br><span class="line">  - cleanup</span><br><span class="line"></span><br><span class="line">build_job:</span><br><span class="line">  stage: build</span><br><span class="line">  script:</span><br><span class="line">    - make build</span><br><span class="line"></span><br><span class="line">cleanup_build_job:</span><br><span class="line">  stage: cleanup_build</span><br><span class="line">  script:</span><br><span class="line">    - cleanup build when failed</span><br><span class="line">  when: on_failure</span><br><span class="line"></span><br><span class="line">test_job:</span><br><span class="line">  stage: test</span><br><span class="line">  script:</span><br><span class="line">    - make test</span><br><span class="line"></span><br><span class="line">deploy_job:</span><br><span class="line">  stage: deploy</span><br><span class="line">  script:</span><br><span class="line">    - make deploy</span><br><span class="line">  when: manual</span><br><span class="line"></span><br><span class="line">cleanup_job:</span><br><span class="line">  stage: cleanup</span><br><span class="line">  script:</span><br><span class="line">    - cleanup after jobs</span><br><span class="line">  when: always</span><br></pre></td></tr></table></figure>

<p>上面的脚本将：</p>
<p>仅当 build_job 失败时才执行 cleanup_build_job。</p>
<p>始终在最后执行 cleanup_job 而不管成功或失败。</p>
<p>允许您从 Gitlab 的用户界面手动执行 Deploy_job。</p>
<h4 id="when-manual"><a href="#when-manual" class="headerlink" title="when:manual"></a>when:manual</h4><p>手动操作是一种特殊类型的 job，不能自动执行，需要由用户显式启动。手动操作的一个示例用法是部署到生产环境。可以从管道、job、环境和部署视图启动手动操作。<a target="_blank" rel="noopener" href="https://gitlab.com/help/ci/environments.md#configuring-manual-deployments">Read more at the<br>environments documentation.</a></p>
<p>手动操作可以是可选的，也可以是阻塞的。阻止手动操作将在定义此操作的阶段阻止管道的执行。它是当有人通过单击播放按钮执行阻止手动操作时，可以恢复管道的执行。</p>
<p>当管道被阻塞时，如果设置了 “管道成功时合并”，则不会合并管道。阻塞的管道也有一个特殊的状态，称为手动。默认情况下，手动操作是非阻塞的。如果要进行手动操作阻止，则必须在.gitlab-ci.yml 中的 job 定义中添加 allow_failure:false。</p>
<p>可选的手动操作默认情况下 allow_failure: true，其状态不会影响整个管道状态。因此，如果手动操作失败，管道最终会成功。</p>
<p>手动操作被认为是写操作，因此当用户希望触发操作时，将使用受保护分支的权限。换句话说，为了触发分配给正在运行管道的分支的手动操作，用户需要能够合并到此分支。</p>
<h4 id="when-delayed"><a href="#when-delayed" class="headerlink" title="when:delayed"></a>when:delayed</h4><p>延迟 job 用于在一段时间后执行脚本。如果希望避免 job 立即进入挂起状态，则此操作非常有用。</p>
<p>您可以用 start_in 键设置周期。除非提供了一个单位，否则 start_in key 的值是以秒为单位的已用时间，并且时间必须小于或等于一小时。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">10 seconds</span><br><span class="line">30 minutes</span><br><span class="line">1 hour</span><br></pre></td></tr></table></figure>

<p>当某个阶段中存在延迟 job 时，管道将不会进行，直到延迟 job 完成。这意味着这个关键字也可以用于在不同阶段之间插入延迟。</p>
<p>延迟 job 的计时器在上一阶段完成后立即启动。与其他类型的 job 类似，延迟 job 的计时器将不会启动，除非上一阶段已通过。</p>
<p>下面的示例创建一个名为 Timed Rollow 10% 的 job，该 job 在上一阶段完成 30 分钟后执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">timed rollout 10%:</span><br><span class="line">  stage: deploy</span><br><span class="line">  script: echo &#39;Rolling out 10% ...&#39;</span><br><span class="line">  when: delayed</span><br><span class="line">  start_in: 30 minutes</span><br></pre></td></tr></table></figure>

<p>通过单击 Unschedule 按钮，可以停止延迟 job 的活动计时器。除非手动执行该 job，否则将来永远不会执行该 job。</p>
<p>您可以通过单击 “播放” 按钮立即启动延迟的 job。Gitlab Runner 将很快选择您的工作并开始工作。</p>
<h3 id="7-12-environment"><a href="#7-12-environment" class="headerlink" title="7.12. environment"></a>7.12. environment</h3><p>environment 用于定义 job 部署到特定环境。如果指定了 environment，并且该名称下不存在任何环境，则将自动创建一个新的环境。</p>
<p>在其最简单的形式中，environment 关键字的定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">deploy to production:</span><br><span class="line">  stage: deploy</span><br><span class="line">  script: git push production HEAD:master</span><br><span class="line">  environment:</span><br><span class="line">    name: production</span><br></pre></td></tr></table></figure>

<p>在上面的示例中，部署到生产 job 将标记为对生产环境进行部署。</p>
<h4 id="environment-name"><a href="#environment-name" class="headerlink" title="environment:name"></a>environment:name</h4><p>The environment name can contain:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">letters</span><br><span class="line">digits</span><br><span class="line">spaces</span><br><span class="line">-</span><br><span class="line">_</span><br><span class="line">&#x2F;</span><br><span class="line">$</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>常见的名称有 qa, staging, and production，但是您可以将任何名称用于您的工作流。</p>
<p>除了在 environment 关键字后定义环境名称，还可以将其定义为单独的值。为此，请在环境下使用 name 关键字：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">deploy to production:</span><br><span class="line">  stage: deploy</span><br><span class="line">  script: git push production HEAD:master</span><br><span class="line">  environment:</span><br><span class="line">    name: production</span><br></pre></td></tr></table></figure>

<h4 id="environment-url"><a href="#environment-url" class="headerlink" title="environment:url"></a>environment:url</h4><p>这是一个可选值，设置后，它会在 Gitlab 中的不同位置显示按钮，单击该按钮会将您带到定义的 URL。</p>
<p>在下面的示例中，如果 job 成功完成，它将在合并请求和环境 / 部署页面中创建按钮，这些页面将指向 <a target="_blank" rel="noopener" href="https://prod.example.com./">https://prod.example.com。</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">deploy to production:</span><br><span class="line">  stage: deploy</span><br><span class="line">  script: git push production HEAD:master</span><br><span class="line">  environment:</span><br><span class="line">    name: production</span><br><span class="line">    url: https:&#x2F;&#x2F;prod.example.com</span><br></pre></td></tr></table></figure>

<h4 id="environment-on-stop"><a href="#environment-on-stop" class="headerlink" title="environment:on_stop"></a>environment:on_stop</h4><p>关闭（停止）环境可以通过在 environment 下定义的 on-stop 关键字来实现。它声明了一个不同的 job，该 job 运行的目的是关闭环境。</p>
<p>例如，请阅读 environment:action 部分。</p>
<h4 id="environment-action"><a href="#environment-action" class="headerlink" title="environment:action"></a>environment:action</h4><p>action 关键字将与 on_stop 一起使用，并在调用以关闭环境的 job 中定义。</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">review_app:</span><br><span class="line">  stage: deploy</span><br><span class="line">  script: make deploy-app</span><br><span class="line">  environment:</span><br><span class="line">    name: review</span><br><span class="line">    on_stop: stop_review_app</span><br><span class="line"></span><br><span class="line">stop_review_app:</span><br><span class="line">  stage: deploy</span><br><span class="line">  variables:</span><br><span class="line">    GIT_STRATEGY: none</span><br><span class="line">  script: make delete-app</span><br><span class="line">  when: manual</span><br><span class="line">  environment:</span><br><span class="line">    name: review</span><br><span class="line">    action: stop</span><br></pre></td></tr></table></figure>

<p>在上面的示例中，我们设置了 review-appjob 以部署到 review 环境中，并且在 on-stop 下定义了一个新的 stop-review-appjob。一旦 review_app 完成，它将根据 “when” 下定义的内容触发 stop_review_app。在本例中，我们将其设置为手动，以便它需要通过 Gitlab 的 Web 界面进行手动操作才能运行。</p>
<p>同样在这个例子中，GIT_STRATEGY 被设置为 “none”，这样当自动触发 stop_review_app 时，Gitlab Runner 不会在删除分支后尝试 check out 代码。</p>
<p>stop_review_app 需要定义以下关键字：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">when - reference</span><br><span class="line">environment:name</span><br><span class="line">environment:action</span><br><span class="line">stage应与review_app相同，以便在删除分支时环境自动停止。</span><br></pre></td></tr></table></figure>

<p>动态环境</p>
<p>For example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">deploy as review app:</span><br><span class="line">  stage: deploy</span><br><span class="line">  script: make deploy</span><br><span class="line">  environment:</span><br><span class="line">    name: review&#x2F;$CI_COMMIT_REF_NAME</span><br><span class="line">    url: https:&#x2F;&#x2F;$CI_ENVIRONMENT_SLUG.example.com&#x2F;</span><br></pre></td></tr></table></figure>

<p>deploy as review app 将标记为 deployment，以动态创建 review/$CI_COMMIT_REF_NAME 环境，其中 $CI_COMMIT_REF_NAME 是运行程序设置的环境变量。$CI_ENVIRONMENT_SLUG 变量基于环境名称，但适合包含在 URL 中。在这种情况下，如果在名为 pow 的分支中运行 deploy as review app，则可以使用类似 <a target="_blank" rel="noopener" href="https://review/">https://review</a> pow.example.com/ 的 URL 访问此环境。</p>
<p>当然，这意味着承载应用程序的底层服务器配置正确。</p>
<p>常见的用例是为分支创建动态环境，并将它们用作审查应用程序。您可以在 <a target="_blank" rel="noopener" href="https://gitlab.com/gitlab-examples/review-apps-nginx/%E4%B8%8A%E7%9C%8B%E5%88%B0%E4%B8%80%E4%B8%AA%E4%BD%BF%E7%94%A8review-apps%E7%9A%84%E7%AE%80%E5%8D%95%E7%A4%BA%E4%BE%8B%E3%80%82">https://gitlab.com/gitlab-examples/review-apps-nginx/ 上看到一个使用 review-apps 的简单示例。</a></p>
<h3 id="7-13-cache"><a href="#7-13-cache" class="headerlink" title="7.13. cache"></a>7.13. cache</h3><p><a target="_blank" rel="noopener" href="https://gitlab.com/help/ci/caching/index.md">TIP: Learn more:Read how caching works and find out some good practices in the caching dependencies documentation.</a></p>
<p>cache 用于指定应在 job 之间缓存的文件和目录的列表。只能使用项目工作区内的路径。</p>
<p>如果 cache 是在 job 范围之外定义的，则意味着它是全局设置的，所有 job 都将使用该定义。</p>
<h4 id="cache-paths"><a href="#cache-paths" class="headerlink" title="cache:paths"></a>cache:paths</h4><p>使用 paths 指令选择将缓存哪些文件或目录。可以使用通配符跟踪 glob 模式和 filepath.match。</p>
<p>缓存以.apk 和.config 文件结尾的二进制文件中的所有文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">rspec:</span><br><span class="line">  script: test</span><br><span class="line">  cache:</span><br><span class="line">    paths:</span><br><span class="line">      - binaries&#x2F;*.apk</span><br><span class="line">      - .config</span><br></pre></td></tr></table></figure>

<p>本地定义的缓存覆盖全局定义的选项。以下 rspecjob 将只缓存二进制文件 /：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">cache:</span><br><span class="line">  paths:</span><br><span class="line">    - my&#x2F;files</span><br><span class="line"></span><br><span class="line">rspec:</span><br><span class="line">  script: test</span><br><span class="line">  cache:</span><br><span class="line">    key: rspec</span><br><span class="line">    paths:</span><br><span class="line">      - binaries&#x2F;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请注意，由于缓存是在 job 之间共享的，如果您对不同的 job 使用不同的路径，则还应设置不同的 cache:key，否则缓存内容会被覆盖。</p>
</blockquote>
<h4 id="cache-key"><a href="#cache-key" class="headerlink" title="cache:key"></a>cache:key</h4><p>由于缓存是在 job 之间共享的，如果您对不同的 job 使用不同的路径，则还应设置不同的 cache:key，否则缓存内容会被覆盖。</p>
<p>key 指令允许您定义 job 之间缓存的关联性，允许为所有 job 都有一个缓存、每个 job 缓存、每个分支缓存。或者其他适合您工作流程的方式。通过这种方式，您可以微调缓存，允许您在不同的 job 之间甚至不同的分支之间缓存数据。</p>
<p>cache:key 变量可以使用任何预定义的变量，如果没有设置默认键，则它只是文字默认值，这意味着默认情况下，从 gitlab 9.0 开始，每个管道和 job 之间共享所有内容。</p>
<blockquote>
<p>cache:key 变量不能包含 / 字符，或者编码为 %2f 的等效 URI；也禁止使用仅由点（.，%2e）构成的值。</p>
</blockquote>
<p>例如，要启用每个分支缓存：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">cache:</span><br><span class="line">  key: &quot;$CI_COMMIT_REF_SLUG&quot;</span><br><span class="line">  paths:</span><br><span class="line">    - binaries&#x2F;</span><br></pre></td></tr></table></figure>

<p>如果使用 Windows 批处理运行 shell 脚本，则需要将 $ 替换为 %：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">cache:</span><br><span class="line">  key: &quot;%CI_COMMIT_REF_SLUG%&quot;</span><br><span class="line">  paths:</span><br><span class="line">    - binaries&#x2F;</span><br></pre></td></tr></table></figure>

<h4 id="cache-untracked"><a href="#cache-untracked" class="headerlink" title="cache:untracked"></a>cache:untracked</h4><p>set untracked:true 缓存 Git 存储库中所有未跟踪的文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">rspec:</span><br><span class="line">  script: test</span><br><span class="line">  cache:</span><br><span class="line">    untracked: true</span><br></pre></td></tr></table></figure>

<p>缓存 binaries 下的所有 Git 未跟踪文件和文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">rspec:</span><br><span class="line">  script: test</span><br><span class="line">  cache:</span><br><span class="line">    untracked: true</span><br><span class="line">    paths:</span><br><span class="line">      - binaries&#x2F;</span><br></pre></td></tr></table></figure>

<h4 id="cache-policy"><a href="#cache-policy" class="headerlink" title="cache:policy"></a>cache:policy</h4><p>缓存 job 的默认行为是在执行开始时下载文件，并在结束时重新上传文件。这允许为将来的运行保留 job 所做的任何更改，称为 pull-push 缓存策略。</p>
<p>如果知道 job 不会更改缓存文件，可以通过设置 policy:pull 来跳过上传步骤。通常，这将与早期阶段的普通缓存 job 成对出现，以确保缓存不时更新：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">stages:</span><br><span class="line">  - setup</span><br><span class="line">  - test</span><br><span class="line"></span><br><span class="line">prepare:</span><br><span class="line">  stage: setup</span><br><span class="line">  cache:</span><br><span class="line">    key: gems</span><br><span class="line">    paths:</span><br><span class="line">      - vendor&#x2F;bundle</span><br><span class="line">  script:</span><br><span class="line">    - bundle install --deployment</span><br><span class="line"></span><br><span class="line">rspec:</span><br><span class="line">  stage: test</span><br><span class="line">  cache:</span><br><span class="line">    key: gems</span><br><span class="line">    paths:</span><br><span class="line">      - vendor&#x2F;bundle</span><br><span class="line">    policy: pull</span><br><span class="line">  script:</span><br><span class="line">    - bundle exec rspec ...</span><br></pre></td></tr></table></figure>

<p>这有助于加快 job 执行速度并减少缓存服务器上的负载，特别是当您有大量的缓存使用并行执行的 job 时。</p>
<p>此外，如果有一个 job 无条件地重新创建缓存而不引用其先前的内容，则可以使用 policy: push 跳过下载步骤。</p>
<h3 id="7-14-artifacts"><a href="#7-14-artifacts" class="headerlink" title="7.14. artifacts"></a>7.14. artifacts</h3><p>artifacts 用于指定在 job 成功、失败或总是失败时应附加到该 job 的文件和目录列表。</p>
<p>artifacts 将在 job 完成后发送到 Gitlab，并可在 Gitlab UI 中下载。<br><a target="_blank" rel="noopener" href="https://gitlab.com/help/user/project/pipelines/job_artifacts.md">Read more about artifacts.</a></p>
<h4 id="artifacts-paths"><a href="#artifacts-paths" class="headerlink" title="artifacts:paths"></a>artifacts:paths</h4><p>只能使用项目工作区内的路径。可以使用通配符跟踪 glob 模式和 filepath.match。</p>
<p>要在不同 job 之间传递 artifacts，see dependencies.。</p>
<p>发送 binaries and .config: 下所有文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">artifacts:</span><br><span class="line">  paths:</span><br><span class="line">    - binaries&#x2F;</span><br><span class="line">    - .config</span><br></pre></td></tr></table></figure>

<p>要禁用 artifacts 传递，请使用 dependencies: []</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">job:</span><br><span class="line">  stage: build</span><br><span class="line">  script: make build</span><br><span class="line">  dependencies: []</span><br></pre></td></tr></table></figure>

<p>您可能希望只为 tags 的版本创建 artifacts，以避免用临时的 artifacts 填充构建服务器存储。</p>
<p>仅为 tags 创建 artifacts（default-job 不会创建 artifacts）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">default-job:</span><br><span class="line">  script:</span><br><span class="line">    - mvn test -U</span><br><span class="line">  except:</span><br><span class="line">    - tags</span><br><span class="line"></span><br><span class="line">release-job:</span><br><span class="line">  script:</span><br><span class="line">    - mvn package -U</span><br><span class="line">  artifacts:</span><br><span class="line">    paths:</span><br><span class="line">      - target&#x2F;*.war</span><br><span class="line">  only:</span><br><span class="line">    - tags</span><br></pre></td></tr></table></figure>

<h4 id="artifacts-name"><a href="#artifacts-name" class="headerlink" title="artifacts:name"></a>artifacts:name</h4><p>name 指令允许您定义创建的 artifacts 存档的名称。这样，当您想从 Gitlab 下载归档文件时，每个归档文件都可以有一个唯一的名称。artifacts:name 变量可以使用任何预定义的变量。默认名称为 artifacts，下载时将变为 artifacts.zip。</p>
<blockquote>
<p>如果您的分支名称包含正斜杠（例如 feature/my feature），建议使用 $ci-commit-ref-slug 而不是 $ci-commit-ref-name 来正确命名 artifacts。</p>
</blockquote>
<p>要使用当前 job 的名称创建存档，请执行以下操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">job:</span><br><span class="line">  artifacts:</span><br><span class="line">    name: &quot;$CI_JOB_NAME&quot;</span><br><span class="line">    paths:</span><br><span class="line">      - binaries&#x2F;</span><br></pre></td></tr></table></figure>

<p>要使用当前分支或标记的名称（仅包括 binaries 文件夹）创建存档，请执行以下操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">job:</span><br><span class="line">  artifacts:</span><br><span class="line">    name: &quot;$CI_COMMIT_REF_NAME&quot;</span><br><span class="line">    paths:</span><br><span class="line">      - binaries&#x2F;</span><br></pre></td></tr></table></figure>

<p>要使用当前 job 的名称和当前分支或标记（仅包括 binaries 文件夹）创建存档，请执行以下操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">job:</span><br><span class="line">  artifacts:</span><br><span class="line">    name: &quot;$CI_JOB_NAME-$CI_COMMIT_REF_NAME&quot;</span><br><span class="line">    paths:</span><br><span class="line">      - binaries&#x2F;</span><br></pre></td></tr></table></figure>

<p>要创建具有当前阶段名称和分支名称的存档，请执行以下操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">job:</span><br><span class="line">  artifacts:</span><br><span class="line">    name: &quot;$CI_JOB_STAGE-$CI_COMMIT_REF_NAME&quot;</span><br><span class="line">    paths:</span><br><span class="line">      - binaries&#x2F;</span><br></pre></td></tr></table></figure>

<p>如果使用 Windows 批处理运行 shell 脚本，则需要将 $ 替换为 %：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">job:</span><br><span class="line">  artifacts:</span><br><span class="line">    name: &quot;%CI_JOB_STAGE%-%CI_COMMIT_REF_NAME%&quot;</span><br><span class="line">    paths:</span><br><span class="line">      - binaries&#x2F;</span><br></pre></td></tr></table></figure>

<p>如果使用 Windows PowerShell 运行 shell 脚本，则需要将 $ 替换为 $env:：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">job:</span><br><span class="line">  artifacts:</span><br><span class="line">    name: &quot;$env:CI_JOB_STAGE-$env:CI_COMMIT_REF_NAME&quot;</span><br><span class="line">    paths:</span><br><span class="line">      - binaries&#x2F;</span><br></pre></td></tr></table></figure>

<h4 id="artifacts-untracked"><a href="#artifacts-untracked" class="headerlink" title="artifacts:untracked"></a>artifacts:untracked</h4><p>artifacts:untracked 用于将所有 git 未跟踪文件添加为 artifacts（沿着 artifacts:paths 中定义的路径）。</p>
<blockquote>
<p>artifacts:untracked 忽略存储库的.gitignore 文件中的配置。</p>
</blockquote>
<p>发送所有 git 未跟踪文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">artifacts:</span><br><span class="line">  untracked: true</span><br></pre></td></tr></table></figure>

<p>发送所有 git 未跟踪文件和二进制文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">artifacts:</span><br><span class="line">  untracked: true</span><br><span class="line">  paths:</span><br><span class="line">    - binaries&#x2F;</span><br></pre></td></tr></table></figure>

<h4 id="artifacts-when"><a href="#artifacts-when" class="headerlink" title="artifacts:when"></a>artifacts:when</h4><p>artifacts:when 用于在 job 失败或尽管失败时上载 artifacts 的时间。</p>
<p>artifacts:when 可以设置为以下值之一：</p>
<p>on_success - 仅当 job 成功时上载 artifacts。这是默认设置。</p>
<p>on_failure - 仅当 job 失败时才上载 artifacts。</p>
<p>always - 上载 artifacts，不管 job 状态如何。</p>
<p>仅当 job 失败时上载项目：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">job:</span><br><span class="line">  artifacts:</span><br><span class="line">    when: on_failure</span><br></pre></td></tr></table></figure>

<h4 id="artifacts-expire-in"><a href="#artifacts-expire-in" class="headerlink" title="artifacts:expire_in"></a>artifacts:expire_in</h4><p>expire_-in 允许您指定 artifacts 在过期之前应该存在多长时间，从而从它们上传和存储到 Gitlab 的时间开始删除。如果未定义到期时间，则默认为实例范围的设置。（默认为 30 天，永远在 gitlab.com 上）。</p>
<p>您可以使用 “job” 页上的 “保留” 按钮来覆盖过期时间并永久保留项目。</p>
<p>过期后，artifacts 默认每小时删除一次（通过 cronjob），并且不再可访问。</p>
<p>expire_in 的值是以秒为单位的已用时间，除非提供了一个单位。可分析值示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">&#39;42&#39;</span><br><span class="line">&#39;3 mins 4 sec&#39;</span><br><span class="line">&#39;2 hrs 20 min&#39;</span><br><span class="line">&#39;2h20min&#39;</span><br><span class="line">&#39;6 mos 1 day&#39;</span><br><span class="line">&#39;47 yrs 6 mos and 4d&#39;</span><br><span class="line">&#39;3 weeks and 2 days&#39;</span><br></pre></td></tr></table></figure>

<p>要在上载后 1 周使项目过期，请执行以下操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">job:</span><br><span class="line">  artifacts:</span><br><span class="line">    expire_in: 1 week</span><br></pre></td></tr></table></figure>

<h4 id="artifacts-reports"><a href="#artifacts-reports" class="headerlink" title="artifacts:reports"></a>artifacts:reports</h4><p>reports 关键字用于从 job 收集测试报告并在 Gitlab 的 UI（合并请求、管道视图）中公开它们。阅读如何将其与 JUnit 报告一起使用。</p>
<blockquote>
<p>无论 job 结果如何（成功或失败），都会收集测试报告。您可以使用 artifacts:expire\u 来设置其 artifacts 的到期日期。<br>如果还希望能够浏览报告输出文件，请包含 artifacts:paths 关键字。</p>
</blockquote>
<h4 id="artifacts-reports-junit"><a href="#artifacts-reports-junit" class="headerlink" title="artifacts:reports:junit"></a>artifacts:reports:junit</h4><p>JUnit 报告将 JUnit XML 文件收集为 artifacts。虽然 JUnit 最初是在爪哇开发的，但是有许多其他第三方端口，如 yml、Python、Ruby 等。</p>
<p>有关更多详细信息和示例，请参阅 JUnit 测试报告。下面是从 Ruby 的 rspec 测试工具收集 JUnit XML 文件的示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">rspec:</span><br><span class="line">  stage: test</span><br><span class="line">  script:</span><br><span class="line">  - bundle install</span><br><span class="line">  - rspec --format RspecJunitFormatter --out rspec.xml</span><br><span class="line">  artifacts:</span><br><span class="line">    reports:</span><br><span class="line">      junit: rspec.xml</span><br></pre></td></tr></table></figure>

<p>收集到的 JUnit 报告将作为 artifacts 上传到 Gitlab，并将自动显示在合并请求中。</p>
<p>如果 JUnit 工具使用导出到多个 XML 文件，则可以在一个 job 中指定多个测试报告路径，这些路径将自动连接到一个文件中。使用文件名模式（junit:rspec-<em>.xml）、文件名数组（junit:[rspec-1.xml、rspec-2.xml、rspec-3.xml]）或其组合（junit:[rspec.xml，测试结果 /test-</em>.xml]）。</p>
<h4 id="artifacts-reports-codequality-STARTER"><a href="#artifacts-reports-codequality-STARTER" class="headerlink" title="artifacts:reports:codequality (STARTER)"></a>artifacts:reports:codequality (STARTER)</h4><p>代码质量报告将代码质量问题收集为 artifacts。</p>
<p>收集的代码质量报告将作为 artifacts 上传到 Gitlab，并将自动显示在合并请求中。</p>
<h4 id="artifacts-reports-sast-ULTIMATE-终极"><a href="#artifacts-reports-sast-ULTIMATE-终极" class="headerlink" title="artifacts:reports:sast (ULTIMATE) 终极"></a>artifacts:reports:sast (ULTIMATE) 终极</h4><p>sast 报告将 sast 漏洞收集为 artifacts。</p>
<p>收集的 SAST 报告将作为 artifacts 上传到 Gitlab，并将自动显示在合并请求、管道视图中，并为安全仪表盘提供数据。</p>
<h4 id="artifacts-reports-dependency-scanning-ULTIMATE-终极"><a href="#artifacts-reports-dependency-scanning-ULTIMATE-终极" class="headerlink" title="artifacts:reports:dependency_scanning (ULTIMATE) 终极"></a>artifacts:reports:dependency_scanning (ULTIMATE) 终极</h4><p>依赖项扫描报告将依赖项扫描漏洞收集为 artifacts。</p>
<p>收集到的依赖项扫描报告将作为 artifacts 上载到 Gitlab，并将自动显示在合并请求、管道视图中，并为安全仪表板提供数据。</p>
<h4 id="artifacts-reports-container-scanning-ULTIMATE"><a href="#artifacts-reports-container-scanning-ULTIMATE" class="headerlink" title="artifacts:reports:container_scanning (ULTIMATE)"></a>artifacts:reports:container_scanning (ULTIMATE)</h4><p>容器扫描报告将容器扫描漏洞收集为 artifacts。</p>
<p>收集的容器扫描报告将作为一个 artifacts 上载到 Gitlab，并将自动显示在合并请求、管道视图中，并为安全仪表板提供数据。</p>
<h4 id="artifacts-reports-dast-ULTIMATE"><a href="#artifacts-reports-dast-ULTIMATE" class="headerlink" title="artifacts:reports:dast (ULTIMATE)"></a>artifacts:reports:dast (ULTIMATE)</h4><p>DAST 报告将 DAST 漏洞收集为 artifacts。</p>
<p>收集的 DAST 报告将作为 artifacts 上传到 Gitlab，并将自动显示在合并请求、管道视图中，并为安全仪表盘提供数据。</p>
<h4 id="artifacts-reports-license-management-ULTIMATE"><a href="#artifacts-reports-license-management-ULTIMATE" class="headerlink" title="artifacts:reports:license_management (ULTIMATE)"></a>artifacts:reports:license_management (ULTIMATE)</h4><p>许可证管理报告将许可证作为 artifacts 收集。</p>
<p>收集的许可证管理报告将作为一个 artifacts 上载到 Gitlab，并将自动显示在合并请求、管道视图中，并为安全仪表盘提供数据。</p>
<h4 id="artifacts-reports-performance-PREMIUM"><a href="#artifacts-reports-performance-PREMIUM" class="headerlink" title="artifacts:reports:performance (PREMIUM)"></a>artifacts:reports:performance (PREMIUM)</h4><p>性能报告将性能指标收集为 artifacts。</p>
<p>收集到的性能报告将作为 artifacts 上传到 Gitlab，并将自动显示在合并请求中。</p>
<h4 id="artifacts-reports-metrics-PREMIUM"><a href="#artifacts-reports-metrics-PREMIUM" class="headerlink" title="artifacts:reports:metrics (PREMIUM)"></a>artifacts:reports:metrics (PREMIUM)</h4><p>性能报告将性能指标收集为 artifacts。<br>收集到的性能报告将作为 artifacts 上传到 Gitlab，并将自动显示在合并请求中。</p>
<h4 id="artifacts-reports-metrics-PREMIUM-1"><a href="#artifacts-reports-metrics-PREMIUM-1" class="headerlink" title="artifacts:reports:metrics (PREMIUM)"></a>artifacts:reports:metrics (PREMIUM)</h4><p>度量报告将度量收集为 artifacts。</p>
<p>收集的度量报告将作为 artifacts 上传到 Gitlab，并将自动显示在合并请求中。</p>
<h3 id="7-15-dependencies"><a href="#7-15-dependencies" class="headerlink" title="7.15. dependencies"></a>7.15. dependencies</h3><p>此功能应该与 artifacts 一起使用，并允许您定义要在不同 job 之间传递的 artifacts。</p>
<p>请注意，默认情况下，来自所有先前阶段的 artifacts 都会被传递。</p>
<p>若要使用此功能，请在 job 的上下文中定义依赖项，并传递一个列表，其中列出了应从中下载 artifacts 的所有先前 job。只能从当前 job 之前执行的阶段定义 job。如果从当前阶段或下一阶段定义 job，将显示一个错误。</p>
<p>定义空数组将跳过下载该 job 的任何 artifacts。使用依赖项时不考虑上一个 job 的状态，因此如果它失败或是未运行的手动 job，则不会发生错误。</p>
<p>在下面的示例中，我们用 artifacts 定义了两个 job，build:osx 和 build:linux。执行 test:osx 时，来自 build:osx 的 artifacts</p>
<p>将在生成上下文中下载和提取。对于 test:linux 和 build:linux 中的 artifacts 也是如此。</p>
<p>由于阶段优先，job 部署将从所有以前的 job 下载项目：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">build:osx:</span><br><span class="line">  stage: build</span><br><span class="line">  script: make build:osx</span><br><span class="line">  artifacts:</span><br><span class="line">    paths:</span><br><span class="line">      - binaries&#x2F;</span><br><span class="line"></span><br><span class="line">build:linux:</span><br><span class="line">  stage: build</span><br><span class="line">  script: make build:linux</span><br><span class="line">  artifacts:</span><br><span class="line">    paths:</span><br><span class="line">      - binaries&#x2F;</span><br><span class="line"></span><br><span class="line">test:osx:</span><br><span class="line">  stage: test</span><br><span class="line">  script: make test:osx</span><br><span class="line">  dependencies:</span><br><span class="line">    - build:osx</span><br><span class="line"></span><br><span class="line">test:linux:</span><br><span class="line">  stage: test</span><br><span class="line">  script: make test:linux</span><br><span class="line">  dependencies:</span><br><span class="line">    - build:linux</span><br><span class="line"></span><br><span class="line">deploy:</span><br><span class="line">  stage: deploy</span><br><span class="line">  script: make deploy</span><br></pre></td></tr></table></figure>

<h4 id="When-a-dependent-job-will-fail"><a href="#When-a-dependent-job-will-fail" class="headerlink" title="When a dependent job will fail"></a>When a dependent job will fail</h4><p>如果设置为依赖项的 job 的 artifacts 已过期或清除，则依赖 job 将失败。</p>
<blockquote>
<p>您可以要求管理员翻转此开关并恢复旧行为。</p>
</blockquote>
<h3 id="7-16-coverage"><a href="#7-16-coverage" class="headerlink" title="7.16. coverage"></a>7.16. coverage</h3><p>Coverage 允许您配置如何从 job 输出中提取代码覆盖率。</p>
<p>正则表达式是此处唯一有效的值类型。因此，为了一致和显式地表示正则表达式字符串，必须使用环绕 /。如果你想从字面上匹配特殊字符，你必须转义它们。</p>
<p>A simple example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">job1:</span><br><span class="line">  script: rspec</span><br><span class="line">  coverage: &#39;&#x2F;Code coverage: \d+\.\d+&#x2F;&#39;</span><br></pre></td></tr></table></figure>

<h3 id="7-17-retry"><a href="#7-17-retry" class="headerlink" title="7.17. retry"></a>7.17. retry</h3><p>重试” 允许您配置一个 job 在发生故障时将重试多少次。</p>
<p>当一个 job 失败并配置了重试时，它将被再次处理到 retry 关键字指定的次数。</p>
<p>如果 retry 设置为 2，并且 job 在第二次运行（第一次重试）中成功，则不会重试。</p>
<p>再一次。重试值必须是一个正整数，等于或大于 0，但小于或等于 2（最多两次重试，总共三次）。</p>
<p>在所有故障情况下重试的简单示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">test:</span><br><span class="line">  script: rspec</span><br><span class="line">  retry: 2</span><br></pre></td></tr></table></figure>

<p>默认情况下，将在所有失败情况下重试 job。要更好地控制重试失败的次数，retry 可以是具有以下键的哈希：</p>
<p>max：最大重试次数。</p>
<p>when：失败的案例要重试。</p>
<p>要最多重试两次运行程序系统故障，请执行以下操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">test:</span><br><span class="line">  script: rspec</span><br><span class="line">  retry:</span><br><span class="line">    max: 2</span><br><span class="line">    when: runner_system_failure</span><br></pre></td></tr></table></figure>

<p>如果存在除运行程序系统故障以外的其他故障，则不会重试 job。</p>
<p>要在多个故障情况下重试，时间也可以是一个故障数组：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">test:</span><br><span class="line">  script: rspec</span><br><span class="line">  retry:</span><br><span class="line">    max: 2</span><br><span class="line">    when:</span><br><span class="line">      - runner_system_failure</span><br><span class="line">      - stuck_or_timeout_failure</span><br></pre></td></tr></table></figure>

<p>Possible values for when are:</p>
<p>always：在出现任何故障时重试（默认）。</p>
<p>unknown_failure：失败原因未知时重试。</p>
<p>script_failure：当脚本失败时重试。</p>
<p>api_failure：在 api 失败时重试。</p>
<p>stuck_or_timeout_failure：当 job 卡住或超时时重试。</p>
<p>runner_system_failure：如果运行程序系统故障（例如设置 job 失败），请重试。</p>
<p>missing_dependency_failure：如果缺少依赖项，请重试。</p>
<p>runner_unsupported：如果运行程序不受支持，请重试。</p>
<h3 id="7-18-parallel"><a href="#7-18-parallel" class="headerlink" title="7.18. parallel"></a>7.18. parallel</h3><p>Parallel 允许您配置要并行运行的 job 实例数。该值必须大于或等于两（2）且小于或等于 50。</p>
<p>这将创建并行运行的同一 job 的 n 个实例。它们按顺序从 job_name 1/n 到 job_name n/n 命名。</p>
<p>对于每个 job，都会设置 CI_NODE_INDEX and CI_NODE_TOTAL environment variables。</p>
<p>一个简单的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">test:</span><br><span class="line">  script: rspec</span><br><span class="line">  parallel: 5</span><br></pre></td></tr></table></figure>

<blockquote>
<p>跨并行 job 并行化测试套件。不同的语言有不同的工具来促进这一点。</p>
</blockquote>
<h3 id="7-19-trigger-PREMIUM"><a href="#7-19-trigger-PREMIUM" class="headerlink" title="7.19. trigger (PREMIUM)"></a>7.19. trigger (PREMIUM)</h3><p>trigger 允许您定义下游管道 trigger。当从 trigger 定义创建的 job 由 Gitlab 启动时，将创建下游管道。<br><a target="_blank" rel="noopener" href="https://gitlab.com/help/ci/multi_project_pipelines.md#creating-multi-project-pipelines-from-gitlab-ciyml">Learn more about multi-project pipelines.</a></p>
<p>简单触发器语法</p>
<p>配置下游触发器以使用具有下游项目完整路径的触发器关键字的最简单方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">rspec:</span><br><span class="line">  stage: test</span><br><span class="line">  script: bundle exec rspec</span><br><span class="line"></span><br><span class="line">staging:</span><br><span class="line">  stage: deploy</span><br><span class="line">  trigger: my&#x2F;deployment</span><br></pre></td></tr></table></figure>

<p>复杂触发器语法</p>
<p>可以配置 Gitlab 用于创建下游管道的分支名称：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">rspec:</span><br><span class="line">  stage: test</span><br><span class="line">  script: bundle exec rspec</span><br><span class="line"></span><br><span class="line">staging:</span><br><span class="line">  stage: deploy</span><br><span class="line">  trigger:</span><br><span class="line">    project: my&#x2F;deployment</span><br><span class="line">    branch: stable</span><br></pre></td></tr></table></figure>

<h3 id="7-20-include"><a href="#7-20-include" class="headerlink" title="7.20. include"></a>7.20. include</h3><p>使用 include 关键字，可以允许包含外部 yaml 文件。include 要求外部 yaml 文件具有扩展名.yml 或.yaml，否则将不包括外部文件。</p>
<p>include 中定义的文件包括：</p>
<p>–与.gitlab-ci.yml 中的合并。</p>
<p>–始终首先评估并与.gitlab-ci.yml 的内容合并，而不管 include 关键字的位置如何。</p>
<blockquote>
<p>使用合并可使用本地定义自定义和覆盖包含的 CI/CD 配置。<br>不支持跨 include 源的不同 yaml 文件使用 yaml 别名。您只能引用同一文件中的别名。您可以使用 extends 关键字，而不是使用 yaml 锚。</p>
</blockquote>
<p>包含支持四个包含方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">local</span><br><span class="line">file</span><br><span class="line">template</span><br><span class="line">remote</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://gitlab.com/help/ci/yaml/README.md#include-examples">See usage examples.</a></p>
<blockquote>
<p>所有方法包含的.gitlab-ci.yml 配置在管道创建时进行评估。配置是一个及时的快照，并持久存在于数据库中。在创建下一个管道之前，对引用的.gitlab-ci.yml 配置所做的任何更改都不会反映在 gitlab 中。</p>
</blockquote>
<h4 id="include-local"><a href="#include-local" class="headerlink" title="include:local"></a>include:local</h4><p>include:local 包含来自与.gitlab-ci.yml 相同存储库的文件。它是使用相对于根目录的完整路径来引用的（/）。</p>
<p>您只能在配置文件所在的分支上使用 Git 当前跟踪的文件。换句话说，当使用 include:local 时，请确保.gitlab-ci.yml 和本地文件都在同一个分支上。</p>
<p>所有嵌套的 include 都将在同一个项目的范围内执行，因此可以使用本地、项目、远程或模板 include。</p>
<blockquote>
<p>不支持通过 git 子模块路径包含本地文件。</p>
</blockquote>
<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">include:</span><br><span class="line">  - local: &#39;&#x2F;templates&#x2F;.gitlab-ci-template.yml&#39;</span><br></pre></td></tr></table></figure>

<h4 id="include-file"><a href="#include-file" class="headerlink" title="include:file"></a>include:file</h4><p>要在同一 Gitlab 实例下包含来自另一个私有项目的文件，请使用 include:file。使用相对于根目录的完整路径（/）引用此文件。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">include:</span><br><span class="line">  - project: &#39;my-group&#x2F;my-project&#39;</span><br><span class="line">    file: &#39;&#x2F;templates&#x2F;.gitlab-ci-template.yml&#39;</span><br></pre></td></tr></table></figure>

<p>还可以指定 ref，默认值为项目的标题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">include:</span><br><span class="line">  - project: &#39;my-group&#x2F;my-project&#39;</span><br><span class="line">    ref: master</span><br><span class="line">    file: &#39;&#x2F;templates&#x2F;.gitlab-ci-template.yml&#39;</span><br><span class="line"></span><br><span class="line">  - project: &#39;my-group&#x2F;my-project&#39;</span><br><span class="line">    ref: v1.0.0</span><br><span class="line">    file: &#39;&#x2F;templates&#x2F;.gitlab-ci-template.yml&#39;</span><br><span class="line"></span><br><span class="line">  - project: &#39;my-group&#x2F;my-project&#39;</span><br><span class="line">    ref: 787123b47f14b552955ca2786bc9542ae66fee5b # Git SHA</span><br><span class="line">    file: &#39;&#x2F;templates&#x2F;.gitlab-ci-template.yml&#39;</span><br></pre></td></tr></table></figure>

<p>所有嵌套的 include 都将在目标项目的范围内执行，因此可以使用本地（相对于目标项目）、项目、远程或模板 include。</p>
<h4 id="include-template"><a href="#include-template" class="headerlink" title="include:template"></a>include:template</h4><p>include:template 可用于包含随 Gitlab 一起提供的.gitlab-ci.yml 模板。</p>
<p>For example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line"># File sourced from GitLab&#39;s template collection</span><br><span class="line">include:</span><br><span class="line">  - template: Auto-DevOps.gitlab-ci.yml</span><br></pre></td></tr></table></figure>

<p>所有嵌套的 include 只能在用户的权限下执行，因此可以使用 project、remote 或 template include。</p>
<h4 id="include-remote"><a href="#include-remote" class="headerlink" title="include:remote"></a>include:remote</h4><p>nclude:remote 可用于包含来自不同位置的文件，使用 http/https，使用完整的 URL 引用。远程文件必须通过简单的 GET 请求公开访问，因为不支持远程 URL 中的身份验证架构。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">include:</span><br><span class="line">  - remote: &#39;https:&#x2F;&#x2F;gitlab.com&#x2F;awesome-project&#x2F;raw&#x2F;master&#x2F;.gitlab-ci-template.yml&#39;</span><br></pre></td></tr></table></figure>

<p>所有嵌套的 include 将作为公共用户在没有上下文的情况下执行，因此只允许使用其他远程、公共项目或模板。</p>
<h4 id="嵌套包含"><a href="#嵌套包含" class="headerlink" title="嵌套包含"></a>嵌套包含</h4><p>嵌套的 include 允许您组成一组 include。总共允许 50 个。</p>
<p>重复包含被视为配置错误。</p>
<p>包括示例</p>
<p>下面还有一些例子。</p>
<p>单个字符串或多个值的数组，您可以将额外的 yaml 文件作为单个字符串或多个值的数组包含在内。下面的例子都是有效的。</p>
<p>包含 include:local 方法的单个字符串：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">include: &#39;&#x2F;templates&#x2F;.after-script-template.yml&#39;</span><br></pre></td></tr></table></figure>

<p>包含 include 方法的数组：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">include:</span><br><span class="line">  - &#39;https:&#x2F;&#x2F;gitlab.com&#x2F;awesome-project&#x2F;raw&#x2F;master&#x2F;.before-script-template.yml&#39;</span><br><span class="line">  - &#39;&#x2F;templates&#x2F;.after-script-template.yml&#39;</span><br></pre></td></tr></table></figure>

<p>显式指定包含方法的单个字符串：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">include:</span><br><span class="line">  remote: &#39;https:&#x2F;&#x2F;gitlab.com&#x2F;awesome-project&#x2F;raw&#x2F;master&#x2F;.before-script-template.yml&#39;</span><br></pre></td></tr></table></figure>

<p>带有 include:remote 的数组是单个项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">include:</span><br><span class="line">  - remote: &#39;https:&#x2F;&#x2F;gitlab.com&#x2F;awesome-project&#x2F;raw&#x2F;master&#x2F;.before-script-template.yml&#39;</span><br></pre></td></tr></table></figure>

<p>具有多个包含方法的数组已明确指定：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">include:</span><br><span class="line">  - remote: &#39;https:&#x2F;&#x2F;gitlab.com&#x2F;awesome-project&#x2F;raw&#x2F;master&#x2F;.before-script-template.yml&#39;</span><br><span class="line">  - local: &#39;&#x2F;templates&#x2F;.after-script-template.yml&#39;</span><br><span class="line">  - template: Auto-DevOps.gitlab-ci.yml</span><br></pre></td></tr></table></figure>

<p>数组混合语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">include:</span><br><span class="line">  - &#39;https:&#x2F;&#x2F;gitlab.com&#x2F;awesome-project&#x2F;raw&#x2F;master&#x2F;.before-script-template.yml&#39;</span><br><span class="line">  - &#39;&#x2F;templates&#x2F;.after-script-template.yml&#39;</span><br><span class="line">  - template: Auto-DevOps.gitlab-ci.yml</span><br><span class="line">  - project: &#39;my-group&#x2F;my-project&#39;</span><br><span class="line">    ref: master</span><br><span class="line">    file: &#39;&#x2F;templates&#x2F;.gitlab-ci-template.yml&#39;</span><br></pre></td></tr></table></figure>

<h4 id="重新使用前脚本模板"><a href="#重新使用前脚本模板" class="headerlink" title="重新使用前脚本模板"></a>重新使用前脚本模板</h4><p>在下面的示例中，.before-script-template.yml 的内容将与.gitlab-ci.yml 的内容一起自动获取和评估。</p>
<p><a target="_blank" rel="noopener" href="https://gitlab.com/awesome">https://gitlab.com/awesome</a> project/raw/master/.before-script-template.yml 的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">before_script:</span><br><span class="line">  - apt-get update -qq &amp;&amp; apt-get install -y -qq sqlite3 libsqlite3-dev nodejs</span><br><span class="line">  - gem install bundler --no-document</span><br><span class="line">  - bundle install --jobs $(nproc)  &quot;$&#123;FLAGS[@]&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>Content of .gitlab-ci.yml:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">include: &#39;https:&#x2F;&#x2F;gitlab.com&#x2F;awesome-project&#x2F;raw&#x2F;master&#x2F;.before-script-template.yml&#39;</span><br><span class="line"></span><br><span class="line">rspec:</span><br><span class="line">  script:</span><br><span class="line">    - bundle exec rspec</span><br></pre></td></tr></table></figure>

<p>覆盖外部模板值以下示例显示了特定的 yaml 定义的变量以及在.gitlab-ci.yml 中自定义的 include 文件中生产 job 的详细信息。</p>
<p><a target="_blank" rel="noopener" href="https://company.com/autodevops-template.yml%E7%9A%84%E5%86%85%E5%AE%B9%EF%BC%9A">https://company.com/autodevops-template.yml 的内容：</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">variables:</span><br><span class="line">  POSTGRES_USER: user</span><br><span class="line">  POSTGRES_PASSWORD: testing_password</span><br><span class="line">  POSTGRES_DB: $CI_ENVIRONMENT_SLUG</span><br><span class="line"></span><br><span class="line">production:</span><br><span class="line">  stage: production</span><br><span class="line">  script:</span><br><span class="line">    - install_dependencies</span><br><span class="line">    - deploy</span><br><span class="line">  environment:</span><br><span class="line">    name: production</span><br><span class="line">    url: https:&#x2F;&#x2F;$CI_PROJECT_PATH_SLUG.$KUBE_INGRESS_BASE_DOMAIN</span><br><span class="line">  only:</span><br><span class="line">    - master</span><br></pre></td></tr></table></figure>

<p>Content of .gitlab-ci.yml:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">include: &#39;https:&#x2F;&#x2F;company.com&#x2F;autodevops-template.yml&#39;</span><br><span class="line"></span><br><span class="line">image: alpine:latest</span><br><span class="line"></span><br><span class="line">variables:</span><br><span class="line">  POSTGRES_USER: root</span><br><span class="line">  POSTGRES_PASSWORD: secure_password</span><br><span class="line"></span><br><span class="line">stages:</span><br><span class="line">  - build</span><br><span class="line">  - test</span><br><span class="line">  - production</span><br><span class="line"></span><br><span class="line">production:</span><br><span class="line">  environment:</span><br><span class="line">    url: https:&#x2F;&#x2F;domain.com</span><br></pre></td></tr></table></figure>

<p>在这种情况下，变量 postgres-user 和 postgres-password 以及 autodevops-template.yml 中定义的生产 job 的环境 url 已被.gitlab-ci.yml 中定义的新值覆盖。</p>
<p>合并允许扩展和重写字典映射，但不能向包含的数组添加或修改项。例如，要向生产 job 脚本添加其他项，必须重复现有的脚本项：</p>
<p><a target="_blank" rel="noopener" href="https://company.com/autodevops-template.yml%E7%9A%84%E5%86%85%E5%AE%B9%EF%BC%9A">https://company.com/autodevops-template.yml 的内容：</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">production:</span><br><span class="line">  stage: production</span><br><span class="line">  script:</span><br><span class="line">    - install_dependencies</span><br><span class="line">    - deploy</span><br></pre></td></tr></table></figure>

<p>Content of .gitlab-ci.yml:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">include: &#39;https:&#x2F;&#x2F;company.com&#x2F;autodevops-template.yml&#39;</span><br><span class="line"></span><br><span class="line">stages:</span><br><span class="line">  - production</span><br><span class="line"></span><br><span class="line">production:</span><br><span class="line">  script:</span><br><span class="line">    - install_dependencies</span><br><span class="line">    - deploy</span><br><span class="line">    - notify_owner</span><br></pre></td></tr></table></figure>

<p>在这种情况下，如果在.gitlab-ci.yml 中不重复 install_dependencies 和 deploy，它们将不会成为组合 CI 配置中生产 job 脚本的一部分。</p>
<h4 id="使用嵌套的-include"><a href="#使用嵌套的-include" class="headerlink" title="使用嵌套的 include"></a>使用嵌套的 include</h4><p>下面的示例说明如何使用不同方法的组合从不同的源嵌套 include。</p>
<p>在本例中，.gitlab-ci.yml 包含本地文件 /.gitlab-ci/another-config.yml：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">include:</span><br><span class="line">  - local: &#x2F;.gitlab-ci&#x2F;another-config.yml</span><br></pre></td></tr></table></figure>

<p>.gitlab ci/another-config.yml 包含一个模板和另一个项目的 /templates/docker-workflow.yml 文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">include:</span><br><span class="line">  - template: Bash.gitlab-ci.yml</span><br><span class="line">  - project: group&#x2F;my-project</span><br><span class="line">    file: &#x2F;templates&#x2F;docker-workflow.yml</span><br></pre></td></tr></table></figure>

<p>group/my 项目中的 /templates/docker-workflow.yml 包含 group/my 项目的两个本地文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">include:</span><br><span class="line">  - local: &#x2F;templates&#x2F;docker-build.yml</span><br><span class="line">  - local: &#x2F;templates&#x2F;docker-testing.yml</span><br></pre></td></tr></table></figure>

<p>group/my 项目中的 /templates/docker-build.yml 添加了一个 docker 构建 job：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">docker-build:</span><br><span class="line">  script: docker build -t my-image .</span><br></pre></td></tr></table></figure>

<p>我们的第二个 /templates/docker-test.yml 出现在 group/my 项目中，它添加了一个 docker 测试 job：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">docker-test:</span><br><span class="line">  script: docker run my-image &#x2F;run&#x2F;tests.sh</span><br></pre></td></tr></table></figure>

<h3 id="7-21-extends"><a href="#7-21-extends" class="headerlink" title="7.21. extends"></a>7.21. extends</h3><p>扩展定义了使用扩展的 job 将从中继承的项名称。</p>
<p>它是使用 yaml 锚的替代方法，并且更灵活和易读：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">.tests:</span><br><span class="line">  script: rake test</span><br><span class="line">  stage: test</span><br><span class="line">  only:</span><br><span class="line">    refs:</span><br><span class="line">      - branches</span><br><span class="line"></span><br><span class="line">rspec:</span><br><span class="line">  extends: .tests</span><br><span class="line">  script: rake rspec</span><br><span class="line">  only:</span><br><span class="line">    variables:</span><br><span class="line">      - $RSPEC</span><br></pre></td></tr></table></figure>

<p>在上面的示例中，rspecjob 继承自.tests 模板 job。Gitlab 将根据这些键执行反向深进。Gitlab 想要：</p>
<p>递归地将 rspec 内容放入.tests。</p>
<p>不去键的值。</p>
<p>这将导致以下 job：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">rspec:</span><br><span class="line">  script: rake rspec</span><br><span class="line">  stage: test</span><br><span class="line">  only:</span><br><span class="line">    refs:</span><br><span class="line">      - branches</span><br><span class="line">    variables:</span><br><span class="line">      - $RSPEC</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请注意，script:rake 测试已被 script:rake rspec 覆盖。</p>
</blockquote>
<p>如果您想包括 rake 测试，请参见之前的脚本和之后的脚本。</p>
<p>. 本例中的测试是隐藏的密钥，但也可以从常规 job 继承。扩展支持多级别继承，但不建议使用三个以上的级别。支持的最大嵌套级别为 10。</p>
<p>以下示例具有两个继承级别：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">.tests:</span><br><span class="line">  only:</span><br><span class="line">    - pushes</span><br><span class="line"></span><br><span class="line">.rspec:</span><br><span class="line">  extends: .tests</span><br><span class="line">  script: rake rspec</span><br><span class="line"></span><br><span class="line">rspec 1:</span><br><span class="line">  variables:</span><br><span class="line">    RSPEC_SUITE: &#39;1&#39;</span><br><span class="line">  extends: .rspec</span><br><span class="line"></span><br><span class="line">rspec 2:</span><br><span class="line">  variables:</span><br><span class="line">    RSPEC_SUITE: &#39;2&#39;</span><br><span class="line">  extends: .rspec</span><br><span class="line"></span><br><span class="line">spinach:</span><br><span class="line">  extends: .tests</span><br><span class="line">  script: rake spinach</span><br></pre></td></tr></table></figure>

<p>在 Gitlab 12.0 及更高版本中，也可以使用多个父级进行扩展。用于合并的算法是 “最近的作用域获胜”，因此来自最后一个成员的键将始终隐藏在其他级别上定义的任何内容。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">.only-important:</span><br><span class="line">  only:</span><br><span class="line">    - master</span><br><span class="line">    - stable</span><br><span class="line">  tags:</span><br><span class="line">    - production</span><br><span class="line"></span><br><span class="line">.in-docker:</span><br><span class="line">  tags:</span><br><span class="line">    - docker</span><br><span class="line">  image: alpine</span><br><span class="line"></span><br><span class="line">rspec:</span><br><span class="line">  extends:</span><br><span class="line">    - .only-important</span><br><span class="line">    - .in-docker</span><br><span class="line">  script:</span><br><span class="line">    - rake rspec</span><br></pre></td></tr></table></figure>

<p>这将导致以下 RSPECjob：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">rspec:</span><br><span class="line">  only:</span><br><span class="line">    - master</span><br><span class="line">    - stable</span><br><span class="line">  tags:</span><br><span class="line">    - docker</span><br><span class="line">  image: alpine</span><br><span class="line">  script:</span><br><span class="line">    - rake rspec</span><br></pre></td></tr></table></figure>

<h4 id="Using-extends-and-include-together"><a href="#Using-extends-and-include-together" class="headerlink" title="Using extends and include together"></a>Using extends and include together</h4><p>扩展配置文件和 include 的工作。</p>
<p>例如，如果您有本地 included.yml 文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">.template:</span><br><span class="line">  script:</span><br><span class="line">    - echo Hello!</span><br></pre></td></tr></table></figure>

<p>然后，在.gitlab-ci.yml 中，您可以这样使用它：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">include: included.yml</span><br><span class="line"></span><br><span class="line">useTemplate:</span><br><span class="line">  image: alpine</span><br><span class="line">  extends: .template</span><br></pre></td></tr></table></figure>

<p>这将运行一个名为 usetemplate 的 job，该 job 运行 echo hello！根据.templatejob 中的定义，并使用本地 job 中定义的 Alpine Docker 图像。</p>
<h3 id="7-22-pages"><a href="#7-22-pages" class="headerlink" title="7.22. pages"></a>7.22. pages</h3><p>页面是一项特殊的工作，用于将静态内容上载到 Gitlab，该工作可用于为您的网站提供服务。它有一个特殊的语法，所以这两个</p>
<p>必须满足以下要求：</p>
<p>任何静态内容都必须放在 public / 目录下。</p>
<p>必须定义具有公共 / 目录路径的项目。</p>
<p>下面的示例只是将所有文件从项目的根目录移动到 public/directory。.public 解决方案是这样的，cp 不会无限循环地将 public / 复制到自身：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">pages:</span><br><span class="line">  stage: deploy</span><br><span class="line">  script:</span><br><span class="line">    - mkdir .public</span><br><span class="line">    - cp -r * .public</span><br><span class="line">    - mv .public public</span><br><span class="line">  artifacts:</span><br><span class="line">    paths:</span><br><span class="line">      - public</span><br><span class="line">  only:</span><br><span class="line">    - master</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://gitlab.com/help/user/project/pages/index.md">Read more on GitLab Pages user documentation.</a></p>
<h3 id="7-23-variables"><a href="#7-23-variables" class="headerlink" title="7.23. variables"></a>7.23. variables</h3><p>&gt; 整数（以及字符串）对于变量的名称和值都是合法的。浮动不合法，不能使用。</p>
<p>Gitlab CI/CD 允许您在.gitlab-ci.yml 中定义变量，然后在 job 环境中传递这些变量。它们可以全局设置，也可以按 job 设置。</p>
<p>在 job 级别上使用 variables 关键字时，它将覆盖全局 yaml 变量和预定义变量。</p>
<p>它们存储在 Git 存储库中，用于存储非敏感项目配置，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">variables:</span><br><span class="line">  DATABASE_URL: &quot;postgres:&#x2F;&#x2F;postgres@postgres&#x2F;my_database&quot;</span><br></pre></td></tr></table></figure>

<p>这些变量稍后可以在所有执行的命令和脚本中使用。yaml 定义的变量也被设置为所有创建的服务容器，从而允许对它们进行微调。</p>
<p>除了用户定义的变量之外，还有运行程序本身设置的变量。一个例子是 ci-commit-ref-name，它具有为其构建项目的分支或标记名的值。除了可以在.gitlab-ci.yml 中设置的变量外，还可以在 gitlab 的用户界面中设置所谓的变量。<br><a target="_blank" rel="noopener" href="https://gitlab.com/help/ci/variables/README.md">Learn more about variables and their priority.</a></p>
<h4 id="Git-strategy"><a href="#Git-strategy" class="headerlink" title="Git strategy"></a>Git strategy</h4><p>您可以在 “变量” 部分中设置用于获取最新应用程序代码的 Git_策略（全局或每个 job）。如果未指定，将使用项目设置中的默认值。</p>
<p>有三个可能的值：clone、fetch 和 none。</p>
<p>克隆是最慢的选项。它为每个 job 从头克隆存储库，确保项目工作空间始终是原始的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">variables:</span><br><span class="line">  GIT_STRATEGY: clone</span><br></pre></td></tr></table></figure>

<p>提取速度更快，因为它重新使用项目工作区（如果不存在则返回到克隆）。Git Clean 用于撤消上一个 job 所做的任何更改，Git Fetch 用于检索自上一个 job 运行以来所做的提交。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">variables:</span><br><span class="line">  GIT_STRATEGY: fetch</span><br></pre></td></tr></table></figure>

<p>也没有人会重新使用项目工作区，但会跳过所有 Git 操作（包括 Gitlab Runner 的预克隆脚本，如果存在的话）。它主要用于只在 artifacts 上操作的 job（例如部署）。Git 存储库数据可能存在，但它肯定是过时的，因此您应该只依赖从缓存或 artifacts 引入到项目工作区的文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">variables:</span><br><span class="line">  GIT_STRATEGY: none</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Kubernetes 的执行者不支持 Git_策略，但将来可能会支持。有关更新，请参阅支持带 kubernetes 执行器的 git 策略的特性建议。</p>
</blockquote>
<h4 id="Git-submodule-strategy"><a href="#Git-submodule-strategy" class="headerlink" title="Git submodule strategy"></a>Git submodule strategy</h4><p>Git_子模块_策略变量用于控制在生成前获取代码时是否包含 Git 子模块 / 如何包含 Git 子模块。您可以在 “变量” 部分中全局或按 job 设置它们。</p>
<p>有三个可能的值：无、正常和递归：</p>
<p>无表示在获取项目代码时不包括子模块。这是默认值，与 v1.10 之前的行为匹配。</p>
<p>正常意味着只包括顶级子模块。相当于：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">git submodule sync</span><br><span class="line">git submodule update --init</span><br></pre></td></tr></table></figure>

<p>递归意味着将包括所有子模块（包括子模块的子模块）。此功能需要 Git v1.8.1 及更高版本。当使用不基于 Docker 的执行器的 Gitlab 运行程序时，请确保 Git 版本满足该要求。相当于：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">git submodule sync --recursive</span><br><span class="line">git submodule update --init --recursive</span><br></pre></td></tr></table></figure>

<p>请注意，要使此功能正常工作，子模块必须（在.gitmodules 中）配置为：</p>
<p>公共可访问存储库的 HTTP（S）URL，或指向同一 Gitlab 服务器上另一个存储库的相对路径。请参见 Git 子模块文档。</p>
<h4 id="Git-checkout"><a href="#Git-checkout" class="headerlink" title="Git checkout"></a>Git checkout</h4><p>当 git 策略设置为 clone 或 fetch 以指定是否应运行 git 签出时，可以使用 git 签出变量。如果未指定，则默认为 true。您可以在 “变量” 部分中全局或按 job 设置它们。如果设置为 false，则运行程序将：</p>
<p>执行提取时 - 更新存储库并将工作副本保留在当前版本上，执行克隆时 - 克隆存储库并将工作副本保留在默认分支上。</p>
<p>将此设置设置为 true 意味着对于克隆和获取策略，运行程序将签出工作副本到与 CI 管道相关的修订：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">variables:</span><br><span class="line">  GIT_STRATEGY: clone</span><br><span class="line">  GIT_CHECKOUT: &quot;false&quot;</span><br><span class="line">script:</span><br><span class="line">  - git checkout -B master origin&#x2F;master</span><br><span class="line">  - git merge $CI_COMMIT_SHA</span><br></pre></td></tr></table></figure>

<h4 id="Git-clean-flags"><a href="#Git-clean-flags" class="headerlink" title="Git clean flags"></a>Git clean flags</h4><p>git-clean-flags 变量用于控制签出源后 git-clean 的默认行为。您可以全局设置它，也可以在变量部分中为每个 job 设置它。</p>
<p>git_clean_标志接受 git clean 命令的所有可能选项。</p>
<p>如果指定了 git_checkout:false，则禁用 git clean。如果 git_clean_标志是：</p>
<p>未指定，git clean 标志默认为 - ffdx。</p>
<p>给定值 none，不执行 git clean。</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">variables:</span><br><span class="line">  GIT_CLEAN_FLAGS: -ffdx -e cache&#x2F;</span><br><span class="line">script:</span><br><span class="line">  - ls -al cache&#x2F;</span><br></pre></td></tr></table></figure>

<h4 id="Job-stages-attempts"><a href="#Job-stages-attempts" class="headerlink" title="Job stages attempts"></a>Job stages attempts</h4><p>您可以设置正在运行的 job 将尝试执行以下每个阶段的尝试次数：</p>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>GET_SOURCES_ATTEMPTS</td>
<td>尝试获取运行 job 的源的次数</td>
</tr>
<tr>
<td>ARTIFACT_DOWNLOAD_ATTEMPTS</td>
<td>尝试下载运行 job 的项目的次数</td>
</tr>
<tr>
<td>RESTORE_CACHE_ATTEMPTS</td>
<td>尝试还原运行 job 的缓存的次数</td>
</tr>
</tbody></table>
<p>默认为一次尝试。</p>
<p>Example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">variables:</span><br><span class="line">  GET_SOURCES_ATTEMPTS: 3</span><br></pre></td></tr></table></figure>

<h4 id="Shallow-cloning"><a href="#Shallow-cloning" class="headerlink" title="Shallow cloning"></a>Shallow cloning</h4><p>可以使用 git_depth 指定提取和克隆的深度。这允许对存储库进行浅层克隆，这可以显著加快对具有大量提交或旧的大型二进制文件的存储库的克隆。价值是</p>
<p>传递给了 git fetch 和 git clone。</p>
<blockquote>
<p>如果使用深度 1 并有 job 队列或重试 job，则 job 可能会失败。</p>
</blockquote>
<p>因为 Git 获取和克隆是基于引用的，例如分支名称，所以运行者不能克隆特定的 commit SHA。如果队列中有多个 job，或者您正在重试一个旧 job，那么要测试的提交需要在克隆的 Git 历史记录中。为 GIT_DEPTH 设置的值太小可能导致无法运行这些旧提交。您将在中看到未解决的引用</p>
<p>job 日志。然后，您应该重新考虑将 GIT_DEPTH 更改为更高的值。</p>
<p>当设置 GIT_DEPTH 时，依赖于 Git 描述的 job 可能无法正常工作，因为 Git 历史只有一部分存在。</p>
<p>要仅获取或克隆最后 3 个提交：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">YML</span><br><span class="line">variables:</span><br><span class="line">  GIT_DEPTH: &quot;3&quot;</span><br></pre></td></tr></table></figure>

<p>您可以全局设置它，也可以在变量部分中为每个 job 设置它。</p>
<h3 id="8-不推荐使用的参数-见原文"><a href="#8-不推荐使用的参数-见原文" class="headerlink" title="8. 不推荐使用的参数 (见原文)"></a>8. 不推荐使用的参数 (见原文)</h3><p>以下参数已弃用。……</p>
<blockquote>
<p> <strong>文章作者:</strong> <a href="mailto:undefined">雪人</a></p>
<p><strong>文章链接:</strong> <a target="_blank" rel="noopener" href="https://www.webq.top/2020/11/19/doc/ci/">https://www.webq.top/2020/11/19/doc/ci/</a></p>
</blockquote>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Gitlab/" rel="tag"># Gitlab</a>
              <a href="/tags/DevOps/" rel="tag"># DevOps</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/08/12/gitlab%E6%90%AD%E5%BB%BA%E5%8F%8ADevOps%E5%88%9D%E6%8E%A2/" rel="prev" title="gitlab搭建及DevOps初探">
                  <i class="fa fa-chevron-left"></i> gitlab搭建及DevOps初探
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
  
  
  



      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhimma</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  















  








  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"superSample":2,"width":200,"height":300,"position":"right","hOffset":0,"vOffset":0},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false});</script></body>
</html>
